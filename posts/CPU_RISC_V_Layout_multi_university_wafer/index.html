<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Cpu_risc_v_layout_multi_university_wafer" /><meta property="og:locale" content="en" /><meta name="description" content="Chip RISC V CPU: Physical tape out in a Jupyter notebook on ExamScale Cluster" /><meta property="og:description" content="Chip RISC V CPU: Physical tape out in a Jupyter notebook on ExamScale Cluster" /><link rel="canonical" href="https://snitgit.github.io/posts/CPU_RISC_V_Layout_multi_university_wafer/" /><meta property="og:url" content="https://snitgit.github.io/posts/CPU_RISC_V_Layout_multi_university_wafer/" /><meta property="og:site_name" content="Extreme Tools for Science and Engineering Discovery" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-14T00:00:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Cpu_risc_v_layout_multi_university_wafer" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-15T06:50:30+07:00","datePublished":"2022-10-14T00:00:00+07:00","description":"Chip RISC V CPU: Physical tape out in a Jupyter notebook on ExamScale Cluster","headline":"Cpu_risc_v_layout_multi_university_wafer","mainEntityOfPage":{"@type":"WebPage","@id":"https://snitgit.github.io/posts/CPU_RISC_V_Layout_multi_university_wafer/"},"url":"https://snitgit.github.io/posts/CPU_RISC_V_Layout_multi_university_wafer/"}</script><title>Cpu_risc_v_layout_multi_university_wafer | Extreme Tools for Science and Engineering Discovery</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Extreme Tools for Science and Engineering Discovery"><meta name="application-name" content="Extreme Tools for Science and Engineering Discovery"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> </a></div><div class="site-title mt-3"> <a href="/">Extreme Tools for Science and Engineering Discovery</a></div><div class="site-subtitle font-italic">Welcome Faculty Visit</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/snitgit" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['snit.san','mahidol...'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Cpu_risc_v_layout_multi_university_wafer</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Cpu_risc_v_layout_multi_university_wafer</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1665680400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 14, 2022 </em> </span> <span> Updated <em class="" data-ts="1665791430" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 15, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/username">SNIT SANGHLAO</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2608 words"> <em>14 min</em> read</span></div></div></div><div class="post-content"><h1 id="chip-risc-v-cpu-physical-tape-out-in-a-jupyter-notebook-on-examscale-cluster">Chip RISC V CPU: Physical tape out in a Jupyter notebook on ExamScale Cluster</h1><p>Motivated by difficulty experiences in IC Design about 18 and 8 years ago, this note will save time and resource for <strong>next generation Electronics Engineering and Computer Science</strong> who are <strong>interested in digital and mixed-signal integrate circuit</strong>. If I could persuade you to rethink about Open Source tools for real-world digital/analog chip design and tape out for manufacture <strong>efabless University program</strong> efabless.com</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1"># $![image.png](attachment:460a7c8f-901b-46a3-bf6d-25d5c1d8e9eb.png)
</span><span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>
<span class="n">display</span><span class="p">.</span><span class="n">Image</span><span class="p">(</span><span class="s">"https://efabless.com/lib_CUsguFEVafmoKCKW/klx999yu9pesnun9.png"</span><span class="p">)</span>

</pre></table></code></div></div><p><img data-src="/assets/notebooks/2022-10-14-CPU_RISC_V_Layout_multi_university_wafer_files/2022-10-14-CPU_RISC_V_Layout_multi_university_wafer_2_0.png" alt="Jupyter Notebook Plot" data-proofer-ignore></p><p>Figure: Multi-project-wafer at efabless.com</p><p>It might be four breakthroughs in open source IC design and tape out chip layout to fabricate at chip manufacture.</p><ul><li><p>OpenROAD Project:: Open source tools for complete and complex IC design processes. Compare to commercial tools, OpenLane based on OpenROAD can be applied to Automatic IC design flow which can reduce human interaction for less than 24 hours turn around time from Register Transfer Lever (RTL) to Layout tape process, GDS file.[1]</p><li><p>Open Sky130 PDK, SkyWater Open Source PDK is a collaboration between Google and SkyWater Technology Foundry to provide a fully open source Process Design Kit and related resources, which can be used to create manufacturable designs at SkyWater’s facility. [2]</p><li><p>Muti-project-wafer or MPW, began 1981 Metal Oxide Silicon Implementation Service), established by DARPA as a technical and human infrastructure for VLSI[3], many university course the course produced ‘multi-university, multi-project chip-design demonstration had been ended. New for opportunity for Open chip for university project has been started by Efabless with Skywater and Google partners. [4]</p><li><p>High Performance Computing for CAD/CAM as we create chip layout rendering is a time-consuming task and sometimes lead to failure of project delivery. With GPU, it is not only speed we will achieve, but flexibility in programming is also countless. [5]</p></ul><p>This post will demonstration how to work out on IC design flow from RTL to GDS tape out as shown in following diagram.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>
<span class="n">display</span><span class="p">.</span><span class="n">Image</span><span class="p">(</span><span class="s">"https://antmicro.com/blog/images/openlane-flow.png"</span><span class="p">)</span>
</pre></table></code></div></div><p><img data-src="/assets/notebooks/2022-10-14-CPU_RISC_V_Layout_multi_university_wafer_files/2022-10-14-CPU_RISC_V_Layout_multi_university_wafer_5_0.png" alt="Jupyter Notebook Plot" data-proofer-ignore></p><p>Source[Antmicro · Improving the OpenLane ASIC build flow with open source SystemVerilog support]</p><p>We will demonstrate how to generate physical IC layout design from Verilog RTL for RISC V CPU, named as Picorv32a[6]</p><h2 id="step-0-prepare-environment-and-download-eda"><span class="mr-2">Step 0: Prepare Environment and Download EDA</span><a href="#step-0-prepare-environment-and-download-eda" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Before start jupyter notebook, on any head node, login node</p><p>$conda create –name chipREal</p><p>$conda activate chipReal</p><p>$ mkdir chip_design_tape_out</p><p>$ cd chip_design_tape_out</p><p>$ git clone –depth=1 https://github.com/The-OpenROAD-Project/OpenLane</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="o">%%</span><span class="n">writefile</span> <span class="n">environment</span><span class="p">.</span><span class="n">yml</span>
<span class="n">channels</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">litex</span><span class="o">-</span><span class="n">hub</span>
  <span class="o">-</span> <span class="n">conda</span><span class="o">-</span><span class="n">forge</span>
<span class="n">dependencies</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">open_pdks</span><span class="p">.</span><span class="n">sky130A</span>
  <span class="o">-</span> <span class="n">magic</span>
  <span class="o">-</span> <span class="n">ngspice</span><span class="o">-</span><span class="n">lib</span>
  <span class="o">-</span> <span class="n">gdstk</span>
  <span class="o">-</span> <span class="n">python</span>
  <span class="o">-</span> <span class="n">pip</span>
  <span class="o">-</span> <span class="n">openroad</span>
  <span class="o">-</span> <span class="n">netgen</span>
  <span class="o">-</span> <span class="n">yosys</span>
  <span class="o">-</span> <span class="n">tcllib</span>
  <span class="o">-</span> <span class="n">pyyaml</span>
  <span class="o">-</span> <span class="n">click</span>
  <span class="o">-</span> <span class="n">pip</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">cairosvg</span>
    <span class="o">-</span> <span class="n">pyspice</span>

</pre></table></code></div></div><p>In bash shell not jupyter notebook Update conda environment:</p><p>$ conda env update –file environment.yml</p><h2 id="step-1-prepare-makefile-and-envpy-from-docker-to-singularity"><span class="mr-2">Step 1: Prepare Makefile and env.py, from Docker to Singularity</span><a href="#step-1-prepare-makefile-and-envpy-from-docker-to-singularity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>On ExScale we cannot use Docker so we need to chagne defualt configuration to Singularity configuration in Makefile.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
</pre><td class="rouge-code"><pre><span class="o">%%</span><span class="n">writefile</span> <span class="n">OpenLane</span><span class="o">/</span><span class="n">Makefile</span>
<span class="c1"># Copyright 2020-2022 Efabless Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span><span class="n">PYTHON_BIN</span> <span class="err">?</span><span class="o">=</span> <span class="n">python3</span>

<span class="n">OPENLANE_DIR</span> <span class="err">?</span><span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">pwd</span><span class="p">)</span>

<span class="n">DOCKER_OPTIONS</span> <span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">shell</span> <span class="err">$</span><span class="p">(</span><span class="n">PYTHON_BIN</span><span class="p">)</span> <span class="p">.</span><span class="o">/</span><span class="n">env</span><span class="p">.</span><span class="n">py</span> <span class="n">docker</span><span class="o">-</span><span class="n">config</span><span class="p">)</span>

<span class="n">DOCKER_ARCH</span> <span class="err">?</span><span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">shell</span> <span class="err">$</span><span class="p">(</span><span class="n">PYTHON_BIN</span><span class="p">)</span> <span class="p">.</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">current_platform</span><span class="p">.</span><span class="n">py</span><span class="p">)</span>

<span class="c1"># Allow Configuring Memory Limits
</span><span class="n">ifneq</span> <span class="p">(,</span><span class="err">$</span><span class="p">(</span><span class="n">DOCKER_SWAP</span><span class="p">))</span> <span class="c1"># Set to -1 for unlimited
</span><span class="n">DOCKER_OPTIONS</span> <span class="o">+=</span> <span class="o">--</span><span class="n">memory</span><span class="o">-</span><span class="n">swap</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">DOCKER_SWAP</span><span class="p">)</span>
<span class="n">endif</span>
<span class="n">ifneq</span> <span class="p">(,</span><span class="err">$</span><span class="p">(</span><span class="n">DOCKER_MEMORY</span><span class="p">))</span>
<span class="n">DOCKER_OPTIONS</span> <span class="o">+=</span> <span class="o">--</span><span class="n">memory</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">DOCKER_MEMORY</span><span class="p">)</span>
<span class="c1"># To verify: cat /sys/fs/cgroup/memory/memory.limit_in_bytes inside the container
</span><span class="n">endif</span>

<span class="c1"># Allow using GUIs
</span><span class="n">UNAME_S</span> <span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">uname</span> <span class="o">-</span><span class="n">s</span><span class="p">)</span>
<span class="n">ifeq</span> <span class="p">(</span><span class="err">$</span><span class="p">(</span><span class="n">UNAME_S</span><span class="p">),</span><span class="n">Linux</span><span class="p">)</span>
<span class="n">DOCKER_OPTIONS</span> <span class="o">+=</span> <span class="o">--</span><span class="n">env</span> <span class="n">DISPLAY</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">DISPLAY</span><span class="p">)</span> <span class="o">-</span><span class="n">B</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="p">.</span><span class="n">X11</span><span class="o">-</span><span class="n">unix</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="p">.</span><span class="n">X11</span><span class="o">-</span><span class="n">unix</span> <span class="o">-</span><span class="n">B</span> <span class="err">$</span><span class="p">(</span><span class="n">HOME</span><span class="p">)</span><span class="o">/</span><span class="p">.</span><span class="n">Xauthority</span><span class="p">:</span><span class="o">/</span><span class="p">.</span><span class="n">Xauthority</span> 
  <span class="n">ifneq</span> <span class="p">(</span><span class="s">"$(wildcard $(HOME)/.openroad)"</span><span class="p">,</span><span class="s">""</span><span class="p">)</span>
    <span class="n">DOCKER_OPTIONS</span> <span class="o">+=</span> <span class="o">-</span><span class="n">B</span> <span class="err">$</span><span class="p">(</span><span class="n">HOME</span><span class="p">)</span><span class="o">/</span><span class="p">.</span><span class="n">openroad</span><span class="p">:</span><span class="o">/</span><span class="p">.</span><span class="n">openroad</span>
  <span class="n">endif</span>
<span class="n">endif</span>

<span class="n">THREADS</span> <span class="err">?</span><span class="o">=</span> <span class="mi">1</span>

<span class="n">ifneq</span> <span class="p">(,</span><span class="err">$</span><span class="p">(</span><span class="n">ROUTING_CORES</span><span class="p">))</span>
<span class="n">DOCKER_OPTIONS</span> <span class="o">+=</span> <span class="o">--</span><span class="n">env</span> <span class="n">ROUTING_CORES</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">ROUTING_CORES</span><span class="p">)</span>
<span class="n">endif</span>

<span class="n">include</span> <span class="p">.</span><span class="o">/</span><span class="n">dependencies</span><span class="o">/</span><span class="n">image_name</span><span class="p">.</span><span class="n">mk</span>

<span class="n">TEST_DESIGN</span> <span class="err">?</span><span class="o">=</span> <span class="n">spm</span>
<span class="n">DESIGN_LIST</span> <span class="err">?</span><span class="o">=</span> <span class="n">spm</span>
<span class="n">QUICK_RUN_DESIGN</span> <span class="err">?</span><span class="o">=</span> <span class="n">spm</span>
<span class="n">BENCHMARK</span> <span class="err">?</span><span class="o">=</span> <span class="n">regression_results</span><span class="o">/</span><span class="n">benchmark_results</span><span class="o">/</span><span class="n">SW_HD</span><span class="p">.</span><span class="n">csv</span>
<span class="n">REGRESSION_TAG</span> <span class="err">?</span><span class="o">=</span> <span class="n">TEST_SW_HD</span>
<span class="n">FASTEST_TEST_SET_TAG</span> <span class="err">?</span><span class="o">=</span> <span class="n">FASTEST_TEST_SET</span>
<span class="n">EXTENDED_TEST_SET_TAG</span> <span class="err">?</span><span class="o">=</span> <span class="n">EXTENDED_TEST_SET</span>
<span class="n">PRINT_REM_DESIGNS_TIME</span> <span class="err">?</span><span class="o">=</span> <span class="mi">0</span>

<span class="n">SKYWATER_COMMIT</span> <span class="err">?</span><span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">shell</span> <span class="err">$</span><span class="p">(</span><span class="n">PYTHON_BIN</span><span class="p">)</span> <span class="p">.</span><span class="o">/</span><span class="n">dependencies</span><span class="o">/</span><span class="n">tool</span><span class="p">.</span><span class="n">py</span> <span class="n">sky130</span> <span class="o">-</span><span class="n">f</span> <span class="n">commit</span><span class="p">)</span>
<span class="n">OPEN_PDKS_COMMIT</span> <span class="err">?</span><span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">shell</span> <span class="err">$</span><span class="p">(</span><span class="n">PYTHON_BIN</span><span class="p">)</span> <span class="p">.</span><span class="o">/</span><span class="n">dependencies</span><span class="o">/</span><span class="n">tool</span><span class="p">.</span><span class="n">py</span> <span class="n">open_pdks</span> <span class="o">-</span><span class="n">f</span> <span class="n">commit</span><span class="p">)</span>

<span class="n">export</span> <span class="n">PDK_ROOT</span> <span class="err">?</span><span class="o">=</span> <span class="p">.</span><span class="o">/</span><span class="n">pdks</span>
<span class="n">export</span> <span class="n">PDK_ROOT</span> <span class="p">:</span><span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">shell</span> <span class="err">$</span><span class="p">(</span><span class="n">PYTHON_BIN</span><span class="p">)</span> <span class="o">-</span><span class="n">c</span> <span class="s">"import os; print(os.path.realpath('$(PDK_ROOT)'), end='')"</span><span class="p">)</span>
<span class="n">PDK_OPTS</span> <span class="o">=</span> <span class="o">-</span><span class="n">B</span> <span class="err">$</span><span class="p">(</span><span class="n">PDK_ROOT</span><span class="p">):</span><span class="err">$</span><span class="p">(</span><span class="n">PDK_ROOT</span><span class="p">)</span> <span class="o">--</span><span class="n">env</span> <span class="n">PDK_ROOT</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">PDK_ROOT</span><span class="p">)</span>

<span class="n">export</span> <span class="n">PDK</span> <span class="err">?</span><span class="o">=</span> <span class="n">sky130A</span>


<span class="n">PDK_OPTS</span> <span class="o">+=</span> <span class="o">--</span><span class="n">env</span> <span class="n">PDK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">PDK</span><span class="p">)</span>

<span class="n">ifneq</span> <span class="p">(</span><span class="err">$</span><span class="p">(</span><span class="n">STD_CELL_LIBRARY</span><span class="p">),)</span>
<span class="n">export</span> <span class="n">STD_CELL_LIBRARY</span> <span class="err">?</span><span class="o">=</span> <span class="n">sky130_fd_sc_hd</span>
<span class="n">PDK_OPTS</span> <span class="o">+=</span> <span class="o">--</span><span class="n">env</span> <span class="n">STD_CELL_LIBRARY</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">STD_CELL_LIBRARY</span><span class="p">)</span>
<span class="n">endif</span>

<span class="c1"># ./designs is mounted over ./install so env.tcl is not found inside the Docker
# container if the user had previously installed it.
</span><span class="n">ENV_START</span> <span class="o">=</span> <span class="n">singularity</span> <span class="k">exec</span> <span class="o">--</span><span class="n">nv</span>\
	<span class="o">-</span><span class="n">B</span> <span class="err">$</span><span class="p">(</span><span class="n">OPENLANE_DIR</span><span class="p">):</span><span class="o">/</span><span class="n">openlane</span>\
	<span class="o">-</span><span class="n">B</span> <span class="err">$</span><span class="p">(</span><span class="n">OPENLANE_DIR</span><span class="p">)</span><span class="o">/</span><span class="n">designs</span><span class="p">:</span><span class="o">/</span><span class="n">openlane</span><span class="o">/</span><span class="n">install</span>\
	<span class="err">$</span><span class="p">(</span><span class="n">PDK_OPTS</span><span class="p">)</span>\
	<span class="err">$</span><span class="p">(</span><span class="n">STD_CELL_OPTS</span><span class="p">)</span>\
	<span class="err">$</span><span class="p">(</span><span class="n">DOCKER_OPTIONS</span><span class="p">)</span>

<span class="c1">#ENV_COMMAND = $(ENV_START) $(OPENLANE_IMAGE_NAME)-$(DOCKER_ARCH)
</span><span class="n">ENV_COMMAND</span> <span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">ENV_START</span><span class="p">)</span> <span class="n">openlane</span><span class="p">.</span><span class="n">sif</span> 

<span class="n">ENV_RUN</span> <span class="o">=</span> <span class="n">singularity</span> <span class="n">shell</span> <span class="o">--</span><span class="n">nv</span>\
        <span class="o">-</span><span class="n">B</span> <span class="err">$</span><span class="p">(</span><span class="n">OPENLANE_DIR</span><span class="p">):</span><span class="o">/</span><span class="n">openlane</span>\
        <span class="o">-</span><span class="n">B</span> <span class="err">$</span><span class="p">(</span><span class="n">OPENLANE_DIR</span><span class="p">)</span><span class="o">/</span><span class="n">designs</span><span class="p">:</span><span class="o">/</span><span class="n">openlane</span><span class="o">/</span><span class="n">install</span>\
        <span class="err">$</span><span class="p">(</span><span class="n">PDK_OPTS</span><span class="p">)</span>\
        <span class="err">$</span><span class="p">(</span><span class="n">STD_CELL_OPTS</span><span class="p">)</span>\
        <span class="err">$</span><span class="p">(</span><span class="n">DOCKER_OPTIONS</span><span class="p">)</span>
<span class="n">ENV_COMMAND_RUN</span> <span class="o">=</span> <span class="err">$</span><span class="p">(</span><span class="n">ENV_RUN</span><span class="p">)</span> <span class="n">openlane</span><span class="p">.</span><span class="n">sif</span>

<span class="p">.</span><span class="n">DEFAULT_GOAL</span> <span class="p">:</span><span class="o">=</span> <span class="nb">all</span>

<span class="p">.</span><span class="n">PHONY</span><span class="p">:</span> <span class="nb">all</span>
<span class="nb">all</span><span class="p">:</span> <span class="n">get</span><span class="o">-</span><span class="n">openlane</span> <span class="n">pdk</span>

<span class="p">.</span><span class="n">PHONY</span><span class="p">:</span> <span class="n">openlane</span>
<span class="n">openlane</span><span class="p">:</span> <span class="n">venv</span><span class="o">/</span><span class="n">created</span>
	<span class="o">@</span><span class="n">PYTHON_BIN</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">PWD</span><span class="p">)</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="n">PYTHON_BIN</span><span class="p">)</span> <span class="err">$</span><span class="p">(</span><span class="n">MAKE</span><span class="p">)</span> <span class="o">-</span><span class="n">C</span> <span class="n">docker</span> <span class="n">openlane</span>

<span class="p">.</span><span class="n">PHONY</span><span class="p">:</span> <span class="n">openlane</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">push</span><span class="o">-</span><span class="n">tools</span>
<span class="n">openlane</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">push</span><span class="o">-</span><span class="n">tools</span><span class="p">:</span> <span class="n">venv</span><span class="o">/</span><span class="n">created</span>
	<span class="o">@</span><span class="n">PYTHON_BIN</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">PWD</span><span class="p">)</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="n">PYTHON_BIN</span><span class="p">)</span> <span class="n">BUILD_IF_CANT_PULL</span><span class="o">=</span><span class="mi">1</span> <span class="n">BUILD_IF_CANT_PULL_THEN_PUSH</span><span class="o">=</span><span class="mi">1</span> <span class="err">$</span><span class="p">(</span><span class="n">MAKE</span><span class="p">)</span> <span class="o">-</span><span class="n">C</span> <span class="n">docker</span> <span class="n">openlane</span>

<span class="n">pull</span><span class="o">-</span><span class="n">openlane</span><span class="p">:</span>
	<span class="o">@</span><span class="n">singularity</span> <span class="n">pull</span> <span class="n">openlane</span><span class="p">.</span><span class="n">sif</span> <span class="s">"docker://$(OPENLANE_IMAGE_NAME)"</span>

<span class="n">get</span><span class="o">-</span><span class="n">openlane</span><span class="p">:</span>
	<span class="o">@</span><span class="err">$</span><span class="p">(</span><span class="n">MAKE</span><span class="p">)</span> <span class="n">pull</span><span class="o">-</span><span class="n">openlane</span> <span class="o">||</span> <span class="err">$</span><span class="p">(</span><span class="n">MAKE</span><span class="p">)</span> <span class="n">openlane</span>

<span class="p">.</span><span class="n">PHONY</span><span class="p">:</span> <span class="n">mount</span>
<span class="n">mount</span><span class="p">:</span>
	<span class="n">cd</span> <span class="err">$</span><span class="p">(</span><span class="n">OPENLANE_DIR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> \
	<span class="err">$</span><span class="p">(</span><span class="n">ENV_COMMAND_RUN</span><span class="p">)</span>
        	

<span class="p">.</span><span class="n">PHONY</span><span class="p">:</span> <span class="n">pdk</span>
<span class="n">pdk</span><span class="p">:</span> <span class="n">venv</span><span class="o">/</span><span class="n">created</span>
	<span class="p">.</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="n">PYTHON_BIN</span><span class="p">)</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="nb">dir</span> <span class="n">volare</span>
	<span class="p">.</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">volare</span> <span class="n">enable</span>

<span class="p">.</span><span class="n">PHONY</span><span class="p">:</span> <span class="n">survey</span>
<span class="n">survey</span><span class="p">:</span>
	<span class="err">$</span><span class="p">(</span><span class="n">PYTHON_BIN</span><span class="p">)</span> <span class="p">.</span><span class="o">/</span><span class="n">env</span><span class="p">.</span><span class="n">py</span> <span class="n">issue</span><span class="o">-</span><span class="n">survey</span>


<span class="p">.</span><span class="n">PHONY</span><span class="p">:</span> <span class="n">lint</span>
<span class="n">lint</span><span class="p">:</span> <span class="n">venv</span><span class="o">/</span><span class="n">created</span>
	<span class="p">.</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">black</span> <span class="o">--</span><span class="n">check</span> <span class="p">.</span>
	<span class="p">.</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">flake8</span> <span class="p">.</span>

<span class="p">.</span><span class="n">PHONY</span><span class="p">:</span> <span class="n">start</span><span class="o">-</span><span class="n">build</span><span class="o">-</span><span class="n">env</span>
<span class="n">start</span><span class="o">-</span><span class="n">build</span><span class="o">-</span><span class="n">env</span><span class="p">:</span> <span class="n">venv</span><span class="o">/</span><span class="n">created</span>
	<span class="n">bash</span> <span class="o">-</span><span class="n">c</span> <span class="s">"bash --rcfile &lt;(cat ~/.bashrc ./venv/bin/activate)"</span>

<span class="n">venv</span><span class="p">:</span> <span class="n">venv</span><span class="o">/</span><span class="n">created</span>
<span class="n">venv</span><span class="o">/</span><span class="n">created</span><span class="p">:</span> <span class="p">.</span><span class="o">/</span><span class="n">requirements</span><span class="p">.</span><span class="n">txt</span> <span class="p">.</span><span class="o">/</span><span class="n">requirements_dev</span><span class="p">.</span><span class="n">txt</span> <span class="p">.</span><span class="o">/</span><span class="n">requirements_lint</span><span class="p">.</span><span class="n">txt</span> <span class="p">.</span><span class="o">/</span><span class="n">dependencies</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">precompile_time</span><span class="p">.</span><span class="n">txt</span> <span class="p">.</span><span class="o">/</span><span class="n">dependencies</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">run_time</span><span class="p">.</span><span class="n">txt</span> 
	<span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="p">.</span><span class="o">/</span><span class="n">venv</span>
	<span class="err">$</span><span class="p">(</span><span class="n">PYTHON_BIN</span><span class="p">)</span> <span class="o">-</span><span class="n">m</span> <span class="n">venv</span> <span class="p">.</span><span class="o">/</span><span class="n">venv</span>
	<span class="p">.</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="n">PYTHON_BIN</span><span class="p">)</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="nb">dir</span> <span class="n">pip</span>
	<span class="p">.</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="n">PYTHON_BIN</span><span class="p">)</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="nb">dir</span> <span class="o">-</span><span class="n">r</span> <span class="p">.</span><span class="o">/</span><span class="n">requirements_dev</span><span class="p">.</span><span class="n">txt</span>
	<span class="n">touch</span> <span class="err">$</span><span class="o">@</span>

<span class="n">DLTAG</span><span class="o">=</span><span class="n">custom_design_List</span>
<span class="p">.</span><span class="n">PHONY</span><span class="p">:</span> <span class="n">test_design_list</span> <span class="n">fastest_test_set</span> <span class="n">extended_test_set</span>
<span class="n">fastest_test_set</span><span class="p">:</span> <span class="n">DESIGN_LIST</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">cat</span> <span class="p">.</span><span class="o">/</span><span class="p">.</span><span class="n">github</span><span class="o">/</span><span class="n">test_sets</span><span class="o">/</span><span class="n">fastest_test_set</span><span class="p">)</span>
<span class="n">fastest_test_set</span><span class="p">:</span> <span class="n">DLTAG</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">FASTEST_TEST_SET_TAG</span><span class="p">)</span>
<span class="n">fastest_test_set</span><span class="p">:</span> <span class="n">test_design_list</span>
<span class="n">extended_test_set</span><span class="p">:</span> <span class="n">DESIGN_LIST</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">cat</span> <span class="p">.</span><span class="o">/</span><span class="p">.</span><span class="n">github</span><span class="o">/</span><span class="n">test_sets</span><span class="o">/</span><span class="n">extended_test_set</span><span class="p">)</span>
<span class="n">extended_test_set</span><span class="p">:</span> <span class="n">DLTAG</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">EXTENDED_TEST_SET_TAG</span><span class="p">)</span>
<span class="n">extended_test_set</span><span class="p">:</span> <span class="n">test_design_list</span>
<span class="n">test_design_list</span><span class="p">:</span>
	<span class="n">cd</span> <span class="err">$</span><span class="p">(</span><span class="n">OPENLANE_DIR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> \
		<span class="err">$</span><span class="p">(</span><span class="n">ENV_COMMAND</span><span class="p">)</span> <span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="s">"</span><span class="se">\
</span><span class="s">			python3 run_designs.py</span><span class="se">\
</span><span class="s">			--tag $(DLTAG)</span><span class="se">\
</span><span class="s">			--threads $(THREADS)</span><span class="se">\
</span><span class="s">			--print_rem $(PRINT_REM_DESIGNS_TIME)</span><span class="se">\
</span><span class="s">			--benchmark $(BENCHMARK)</span><span class="se">\
</span><span class="s">			$(DESIGN_LIST)</span><span class="se">\
</span><span class="s">		"</span>
<span class="c1"># -u is needed, as the python buffers the stdout, so no output is generated
</span><span class="n">run_issue_regression</span><span class="p">:</span>
	<span class="n">cd</span> <span class="err">$</span><span class="p">(</span><span class="n">OPENLANE_DIR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> \
		<span class="err">$</span><span class="p">(</span><span class="n">ENV_COMMAND</span><span class="p">)</span> <span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="s">"</span><span class="se">\
</span><span class="s">			python3 -um tests run $(ISSUE_REGRESSION_DESIGN)"</span>

<span class="n">issue_regression_all</span><span class="p">:</span>
	<span class="n">cd</span> <span class="err">$</span><span class="p">(</span><span class="n">OPENLANE_DIR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> \
		<span class="err">$</span><span class="p">(</span><span class="n">ENV_COMMAND</span><span class="p">)</span> <span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="s">"</span><span class="se">\
</span><span class="s">			python3 -um tests run_all"</span>

<span class="p">.</span><span class="n">PHONY</span><span class="p">:</span> <span class="n">test</span>
<span class="n">test</span><span class="p">:</span>
	<span class="n">cd</span> <span class="err">$</span><span class="p">(</span><span class="n">OPENLANE_DIR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> \
		<span class="err">$</span><span class="p">(</span><span class="n">ENV_COMMAND</span><span class="p">)</span> <span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="s">"./flow.tcl -design $(TEST_DESIGN) -tag openlane_test -overwrite"</span>
	<span class="o">@</span><span class="p">[</span> <span class="o">-</span><span class="n">f</span> <span class="err">$</span><span class="p">(</span><span class="n">OPENLANE_DIR</span><span class="p">)</span><span class="o">/</span><span class="n">designs</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="n">TEST_DESIGN</span><span class="p">)</span><span class="o">/</span><span class="n">runs</span><span class="o">/</span><span class="n">openlane_test</span><span class="o">/</span><span class="n">results</span><span class="o">/</span><span class="n">signoff</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="n">TEST_DESIGN</span><span class="p">).</span><span class="n">gds</span> <span class="p">]</span> <span class="o">&amp;&amp;</span> \
		<span class="n">echo</span> <span class="s">"Basic test passed"</span> <span class="o">||</span> \
		<span class="n">echo</span> <span class="s">"Basic test failed"</span>

<span class="p">.</span><span class="n">PHONY</span><span class="p">:</span> <span class="n">quick_run</span>
<span class="n">quick_run</span><span class="p">:</span>
	<span class="n">cd</span> <span class="err">$</span><span class="p">(</span><span class="n">OPENLANE_DIR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> \
		<span class="err">$</span><span class="p">(</span><span class="n">ENV_COMMAND</span><span class="p">)</span> <span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="s">"./flow.tcl -design $(QUICK_RUN_DESIGN)"</span>

<span class="p">.</span><span class="n">PHONY</span><span class="p">:</span> <span class="n">veryclean</span> <span class="n">clean_runs</span> <span class="n">clean_results</span>
<span class="n">veryclean</span><span class="p">:</span>
	<span class="o">@</span><span class="n">git</span> <span class="n">clean</span> <span class="o">-</span><span class="n">fdX</span>

<span class="n">clean_runs</span><span class="p">:</span>
	<span class="o">@</span><span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="p">.</span><span class="o">/</span><span class="n">designs</span><span class="o">/*/</span><span class="n">runs</span> <span class="o">&amp;&amp;</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="p">.</span><span class="o">/</span><span class="n">_build</span><span class="o">/</span><span class="n">it_tc_logs</span> <span class="o">&amp;&amp;</span> <span class="n">echo</span> <span class="s">"Runs cleaned successfully."</span> <span class="o">||</span> <span class="n">echo</span> <span class="s">"Failed to delete runs."</span>
	<span class="o">@</span><span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="p">.</span><span class="o">/</span><span class="n">tests</span><span class="o">/*/</span><span class="n">runs</span> <span class="o">&amp;&amp;</span> <span class="n">echo</span> <span class="s">"Test runs cleaned successfully."</span> <span class="o">||</span> <span class="n">echo</span> <span class="s">"Failed to delete test runs."</span>

<span class="n">clean_results</span><span class="p">:</span>
	<span class="o">@</span><span class="p">{</span> <span class="n">find</span> <span class="n">regression_results</span> <span class="o">-</span><span class="n">mindepth</span> <span class="mi">1</span> <span class="o">-</span><span class="n">maxdepth</span> <span class="mi">1</span> <span class="o">-</span><span class="nb">type</span> <span class="n">d</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="n">benchmark</span> <span class="o">|</span> <span class="n">xargs</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="p">;</span> <span class="p">}</span> <span class="o">&amp;&amp;</span> <span class="n">echo</span> <span class="s">"Results cleaned successfully."</span> <span class="o">||</span> <span class="n">echo</span> <span class="s">"Failed to delete results."</span>

</pre></table></code></div></div><h3 id="correct-docker-environment-to-singularity"><span class="mr-2">Correct Docker Environment to Singularity</span><a href="#correct-docker-environment-to-singularity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>By modified <strong>env.py</strong> in OpenLane</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
</pre><td class="rouge-code"><pre><span class="o">%%</span><span class="n">writefile</span> <span class="n">OpenLane</span><span class="o">/</span><span class="n">env</span><span class="p">.</span><span class="n">py</span>
<span class="c1">#!/usr/bin/env python3
</span>
<span class="c1"># Copyright 2021 Efabless Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="c1"># Note to maintainers/contributors:
#
# Ensure you don't use f strings, non-comment type hints or any other features
# that wouldn't work on Python 3.3
#
# Inevitably, some people won't read the Readme and then complain that the issue
# survey doesn't work on their older Python versions. As long as it's compatible
# with Python 3.3, this script will tell them that their python version is
# below the minimum supported.
</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">dirname</span>

<span class="n">openlane_dir</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="n">is_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">geteuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>

<span class="c1"># Commands
</span><span class="k">def</span> <span class="nf">tool_list</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">dependencies.tool</span> <span class="kn">import</span> <span class="n">Tool</span>

    <span class="n">tools</span> <span class="o">=</span> <span class="n">Tool</span><span class="p">.</span><span class="n">from_metadata_yaml</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">"./dependencies/tool_metadata.yml"</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"%s %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">tool</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tool</span><span class="p">.</span><span class="n">version_string</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">local_install</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">dependencies.installer</span> <span class="kn">import</span> <span class="n">Installer</span>

    <span class="n">installer</span> <span class="o">=</span> <span class="n">Installer</span><span class="p">()</span>
    <span class="n">installer</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">docker_config</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">dependencies.env_info</span> <span class="kn">import</span> <span class="n">ContainerInfo</span>

    <span class="n">cinfo</span> <span class="o">=</span> <span class="n">ContainerInfo</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cinfo</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"No container engine found."</span><span class="p">)</span>
<span class="s">'''
    if cinfo.engine == "docker":
        if cinfo.rootless:
            print("-u 0", end="")
        else:
            uid = (
                subprocess.check_output(["id", "-u", getpass.getuser()])
                .decode("utf8")
                .strip()
            )
            gid = (
                subprocess.check_output(["id", "-g", getpass.getuser()])
                .decode("utf8")
                .strip()
            )
            print("--user %s:%s" % (uid, gid), end="")

'''</span>
<span class="k">def</span> <span class="nf">issue_survey</span><span class="p">():</span>
    <span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="kn">from</span> <span class="nn">dependencies.env_info</span> <span class="kn">import</span> <span class="n">OSInfo</span>
    <span class="kn">from</span> <span class="nn">dependencies.version</span> <span class="kn">import</span> <span class="n">parse</span> <span class="k">as</span> <span class="n">vp</span>

    <span class="n">alerts</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span>

    <span class="n">final_report</span> <span class="o">=</span> <span class="s">""</span>

    <span class="n">os_info</span> <span class="o">=</span> <span class="n">OSInfo</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">final_report</span> <span class="o">+=</span> <span class="n">textwrap</span><span class="p">.</span><span class="n">dedent</span><span class="p">(</span>
        <span class="s">"""</span><span class="se">\
</span><span class="s">        Kernel: %s v%s
        """</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">os_info</span><span class="p">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">os_info</span><span class="p">.</span><span class="n">kernel_version</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">os_info</span><span class="p">.</span><span class="n">distro</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">final_report</span> <span class="o">+=</span> <span class="n">textwrap</span><span class="p">.</span><span class="n">dedent</span><span class="p">(</span>
            <span class="s">"""</span><span class="se">\
</span><span class="s">            Distribution: %s %s
            """</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">os_info</span><span class="p">.</span><span class="n">distro</span><span class="p">,</span> <span class="p">(</span><span class="n">os_info</span><span class="p">.</span><span class="n">distro_version</span> <span class="ow">or</span> <span class="s">""</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="n">python_version</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="n">os_info</span><span class="p">.</span><span class="n">python_version</span><span class="p">)</span>
    <span class="n">minimum_python_version</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="s">"3.6"</span><span class="p">)</span>
    <span class="n">python_message</span> <span class="o">=</span> <span class="s">"OK"</span>
    <span class="n">python_ok</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">python_version</span> <span class="o">&lt;</span> <span class="n">minimum_python_version</span><span class="p">:</span>
        <span class="n">python_message</span> <span class="o">=</span> <span class="s">"BELOW MINIMUM: UPDATE PYTHON"</span>
        <span class="n">python_ok</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">final_report</span> <span class="o">+=</span> <span class="n">textwrap</span><span class="p">.</span><span class="n">dedent</span><span class="p">(</span>
        <span class="s">"""</span><span class="se">\
</span><span class="s">        Python: v%s (%s)
        """</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">python_version</span><span class="p">,</span> <span class="n">python_message</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">os_info</span><span class="p">.</span><span class="n">container_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">container_version</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="n">os_info</span><span class="p">.</span><span class="n">container_info</span><span class="p">.</span><span class="n">version</span><span class="p">)</span>

        <span class="n">container_message</span> <span class="o">=</span> <span class="s">"UNSUPPORTED"</span>
        <span class="k">if</span> <span class="s">"docker"</span> <span class="ow">in</span> <span class="n">os_info</span><span class="p">.</span><span class="n">container_info</span><span class="p">.</span><span class="n">engine</span><span class="p">:</span>
            <span class="n">container_message</span> <span class="o">=</span> <span class="s">"OK"</span>
            <span class="n">minimum_docker_version</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="s">"19.03.12"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">container_version</span> <span class="o">&lt;</span> <span class="n">minimum_docker_version</span><span class="p">:</span>
                <span class="n">container_message</span> <span class="o">=</span> <span class="s">"BELOW MINIMUM: UPDATE DOCKER"</span>

        <span class="n">final_report</span> <span class="o">+=</span> <span class="n">textwrap</span><span class="p">.</span><span class="n">dedent</span><span class="p">(</span>
            <span class="s">"""</span><span class="se">\
</span><span class="s">            Container Engine: %s v%s (%s)
            """</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">os_info</span><span class="p">.</span><span class="n">container_info</span><span class="p">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">container_version</span><span class="p">,</span> <span class="n">container_message</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span>
        <span class="s">"/git_version"</span>
    <span class="p">):</span>  <span class="c1"># i.e. if running inside the OpenLane container
</span>        <span class="k">print</span><span class="p">(</span><span class="s">"Alert: Running in container."</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">alerts</span><span class="p">)</span>
        <span class="n">final_report</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">textwrap</span><span class="p">.</span><span class="n">dedent</span><span class="p">(</span>
                <span class="s">"""</span><span class="se">\
</span><span class="s">                WARNING: issue-survey appears to be running inside the OpenLane
                container.

                This makes it difficult to rule out issues with your
                environment.

                Unless instructed specifically to do so, please run this command
                outside the OpenLane container.
                ---</span><span class="se">\n</span><span class="s">
                """</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="n">final_report</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alert</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">"Critical Alert: No Docker or Docker-compatible container engine was found."</span>
        <span class="p">)</span>
        <span class="n">final_report</span> <span class="o">+=</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="n">alert</span>
        <span class="k">print</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">alerts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">python_ok</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">dependencies.get_tag</span> <span class="kn">import</span> <span class="n">get_tag</span>

        <span class="n">final_report</span> <span class="o">+=</span> <span class="n">textwrap</span><span class="p">.</span><span class="n">dedent</span><span class="p">(</span>
            <span class="s">"""</span><span class="se">\
</span><span class="s">            OpenLane Git Version: %s
            """</span>
            <span class="o">%</span> <span class="n">get_tag</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="n">pip_ok</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pip</span>  <span class="c1"># noqa F401
</span>    <span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
        <span class="n">pip_ok</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">alert</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s">"pip: "</span> <span class="o">+</span> <span class="s">"INSTALLED"</span>
        <span class="k">if</span> <span class="n">pip_ok</span>
        <span class="k">else</span> <span class="s">"NOT FOUND: Please install pip using your operating system's package manager."</span>
    <span class="p">)</span>

    <span class="n">final_report</span> <span class="o">+=</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="n">alert</span>
    <span class="k">print</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">alerts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pip_ok</span><span class="p">:</span>
        <span class="n">venv_ok</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">venv</span>  <span class="c1"># noqa F401
</span>        <span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
            <span class="n">venv_ok</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">alert</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">"python-venv: "</span> <span class="o">+</span> <span class="s">"INSTALLED"</span>
            <span class="k">if</span> <span class="n">venv_ok</span>
            <span class="k">else</span> <span class="s">"NOT FOUND: Please install python-venv using your operating system's package manager."</span>
        <span class="p">)</span>
        <span class="n">final_report</span> <span class="o">+=</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="n">alert</span>
        <span class="k">print</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">alerts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">python_ok</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">dependencies.verify_versions</span> <span class="kn">import</span> <span class="n">verify_versions</span>

        <span class="k">with</span> <span class="n">io</span><span class="p">.</span><span class="n">StringIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s">"OK"</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mismatches</span> <span class="o">=</span> <span class="n">verify_versions</span><span class="p">(</span>
                    <span class="n">no_tools</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">report_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">pdk</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">"PDK"</span><span class="p">)</span> <span class="ow">or</span> <span class="s">"sky130A"</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">mismatches</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s">"MISMATCH"</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s">"FAILED"</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Failed to verify sky130A."</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">final_report</span> <span class="o">+=</span> <span class="s">"---</span><span class="se">\n</span><span class="s">PDK Version Verification Status: %s</span><span class="se">\n</span><span class="s">%s"</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">status</span><span class="p">,</span>
                <span class="n">f</span><span class="p">.</span><span class="n">getvalue</span><span class="p">(),</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">git_log</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">check_output</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s">"git"</span><span class="p">,</span>
                    <span class="s">"log"</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s">"--format=%h %cI %s - %an - %gs (%D)"</span><span class="p">,</span>
                    <span class="s">"-n"</span><span class="p">,</span>
                    <span class="s">"3"</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">).</span><span class="n">decode</span><span class="p">(</span><span class="s">"utf8"</span><span class="p">)</span>

            <span class="n">final_report</span> <span class="o">+=</span> <span class="s">"---</span><span class="se">\n</span><span class="s">Git Log (Last 3 Commits)</span><span class="se">\n\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">git_log</span>

            <span class="n">remotes</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">check_output</span><span class="p">([</span><span class="s">"git"</span><span class="p">,</span> <span class="s">"remote"</span><span class="p">,</span> <span class="s">"-v"</span><span class="p">,</span> <span class="s">"show"</span><span class="p">]).</span><span class="n">decode</span><span class="p">(</span>
                <span class="s">"utf8"</span>
            <span class="p">)</span>

            <span class="n">final_report</span> <span class="o">+=</span> <span class="s">"---</span><span class="se">\n</span><span class="s">Git Remotes</span><span class="se">\n\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">remotes</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">print</span><span class="p">(</span><span class="n">final_report</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span>


<span class="c1"># Entry Point
</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"tool-list"</span><span class="p">:</span> <span class="n">tool_list</span><span class="p">,</span>
        <span class="s">"local-install"</span><span class="p">:</span> <span class="n">local_install</span><span class="p">,</span>
        <span class="s">"docker-config"</span><span class="p">:</span> <span class="n">docker_config</span><span class="p">,</span>
        <span class="s">"issue-survey"</span><span class="p">:</span> <span class="n">issue_survey</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span>
            <span class="s">"Usage: %s (%s)"</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">"|"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">commands</span><span class="p">.</span><span class="n">keys</span><span class="p">())),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span>
        <span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">EX_USAGE</span><span class="p">)</span>

    <span class="n">commands</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

</pre></table></code></div></div><h2 id="step-2-download-the-docker-image-and-install-sky130-pdk"><span class="mr-2">Step 2. Download the Docker Image and Install sky130 PDK</span><a href="#step-2-download-the-docker-image-and-install-sky130-pdk" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Download the Docker image of OpenLane and install sky130 PDK:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="err">!</span><span class="n">cd</span> <span class="n">OpenLane</span> <span class="o">&amp;&amp;</span> <span class="n">make</span>
</pre></table></code></div></div><h2 id="step-3-validating-your-openlane-installation"><span class="mr-2">Step 3: Validating your OpenLane Installation</span><a href="#step-3-validating-your-openlane-installation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Test the installed PDK and OpenLane:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="err">!</span><span class="n">cd</span> <span class="n">OpenLane</span> <span class="o">&amp;&amp;</span> <span class="n">make</span> <span class="n">test</span>
</pre></table></code></div></div><p>Sucessful test looks like this: Basic test passed</p><h1 id="step-4-run-ic-physical-layout-flow">Step 4: Run IC Physical Layout Flow</h1><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1"># Enter a Singularity session:
</span><span class="err">$</span> <span class="n">cd</span> <span class="n">OpenLane</span> <span class="o">&amp;&amp;</span> <span class="n">make</span> <span class="n">mount</span>

</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1"># inside container shell
</span><span class="n">Singularity</span><span class="o">&gt;</span> <span class="n">cd</span> <span class="o">/</span><span class="n">openlane</span>
<span class="n">Singularity</span><span class="o">&gt;</span> <span class="p">.</span><span class="o">/</span><span class="n">flow</span><span class="p">.</span><span class="n">tcl</span> <span class="o">-</span><span class="n">design</span> <span class="n">picorv32a</span>
</pre></table></code></div></div><h2 id="step-5-view-riscv-cpu-tape-out-layout"><span class="mr-2">Step 5: View RISCV CPU tape out Layout</span><a href="#step-5-view-riscv-cpu-tape-out-layout" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1"># still insice container shell
</span><span class="n">Singularity</span><span class="o">&gt;</span> <span class="n">klayout</span>  
</pre></table></code></div></div><p>open browse of klayout folder to context path of the result dependence on your system. /designs/picorv32a/runs/RUN_2022.10.13_04.40.06/results/final/gds/picorv32.gdsead215ffd805.png</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1"># inside contain if you want to end of synthesis
</span><span class="n">Singularity</span><span class="o">&gt;</span> <span class="nb">exit</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">gdstk</span>
<span class="kn">import</span> <span class="nn">cairosvg</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="n">library</span> <span class="o">=</span> <span class="n">gdstk</span><span class="p">.</span><span class="n">read_gds</span><span class="p">(</span><span class="s">'/home/snit.san/chip_design_tape_out/OpenLane/designs/picorv32a/runs/RUN_2022.10.14_10.45.33/results/final/gds/picorv32.gds'</span><span class="p">)</span>
<span class="n">top_cells</span> <span class="o">=</span> <span class="n">library</span><span class="p">.</span><span class="n">top_level</span><span class="p">()</span>
<span class="n">top_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">write_svg</span><span class="p">(</span><span class="s">'picorv32.svg'</span><span class="p">)</span>
<span class="n">cairosvg</span><span class="p">.</span><span class="n">svg2png</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s">'picorv32.svg'</span><span class="p">,</span> <span class="n">write_to</span><span class="o">=</span><span class="s">'picorv32.png'</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.08</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="s">'picorv32.png'</span><span class="p">)</span>
</pre></table></code></div></div><p><img data-src="/assets/notebooks/2022-10-14-CPU_RISC_V_Layout_multi_university_wafer_files/2022-10-14-CPU_RISC_V_Layout_multi_university_wafer_29_0.png" alt="Jupyter Notebook Plot" data-proofer-ignore></p><p>Singularity image is shared at <em>/shared/software/singularity/images/openlane.sif</em>. With given container image you can modify “Makefile” to mount software for your physcial desing.</p><p>If you want to start design and simulation then it is short introduction to <strong>Verilator</strong> [7-8]</p><h2 id="references"><span class="mr-2">References:</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ol><li><p>OpenROAD project</p><p>https://github.com/The-OpenROAD-Project</p><li><p>Open Source Process Design Kit Skywave 130nm process</p><p>[https://github.com/google/skywater-pdk]</p><li><p>MPW</p><p>https://en.wikipedia.org/wiki/Multi-project_wafer_service</p><li><p>MPW university projgram</p><p>http://efabless.com</p><li><p>High-performance computing (HPC) for manufacturing</p><p>https://learn.microsoft.com/en-us/azure/architecture/industries/manufacturing/compute-manufacturing-overview</p><li><p>Picorv32</p><p>https://github.com/YosysHQ/picorv32</p><li><p>Verilog Primer</p><p>https://inst.eecs.berkeley.edu/~eecs151/fa21/files/verilog/Verilog_Primer_Slides.pdf</p><li><p>Veriator RTL somulation</p><p>https://verilator.org/guide/latest/install.html</p><li><p>Drawing Stick Diagrams</p><p>https://www.southampton.ac.uk/~bim/notes/cad/guides/sticks.html</p></ol><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Cpu_risc_v_layout_multi_university_wafer+-+Extreme+Tools+for+Science+and+Engineering+Discovery&url=https%3A%2F%2Fsnitgit.github.io%2Fposts%2FCPU_RISC_V_Layout_multi_university_wafer%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Cpu_risc_v_layout_multi_university_wafer+-+Extreme+Tools+for+Science+and+Engineering+Discovery&u=https%3A%2F%2Fsnitgit.github.io%2Fposts%2FCPU_RISC_V_Layout_multi_university_wafer%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fsnitgit.github.io%2Fposts%2FCPU_RISC_V_Layout_multi_university_wafer%2F&text=Cpu_risc_v_layout_multi_university_wafer+-+Extreme+Tools+for+Science+and+Engineering+Discovery" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Tensor_network_in_Quantum_Information_Science_Engineering_Physics/">Tensor_network_in_quantum_information_science_engineering_physics</a><li><a href="/posts/Quantum-Drug-Discovery/">Quantum Drug Discovery</a><li><a href="/posts/CPU_RISC_V_Layout_multi_university_wafer/">Cpu_risc_v_layout_multi_university_wafer</a><li><a href="/posts/Reproducible-slurm-notebook/"> Reproducible Slurm Notebook</a><li><a href="/posts/Quantum-Exspesso/">Quantum ESPRESSO on exascale.mahidol.ac.th Multi-Node-Multi-GPUs MNMG Testing</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Tensor_network_in_Quantum_Information_Science_Engineering_Physics/"><div class="card-body"> <em class="small" data-ts="1669741200" data-df="ll" > Nov 30, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Tensor_network_in_quantum_information_science_engineering_physics</h3><div class="text-muted small"><p> Unify Quantum Information Science and Quantum Machine Learning with Quantum Tensor Networks as modern diagrammatic reasoning on GPUs Cluster Boring and waiting for NVIDIA cuQuantum appliance for m...</p></div></div></a></div><div class="card"> <a href="/posts/Quantum-Drug-Discovery/"><div class="card-body"> <em class="small" data-ts="1668618000" data-df="ll" > Nov 17, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Quantum Drug Discovery</h3><div class="text-muted small"><p> Drug Discovery: Protein Folding on IBM’s Qiskit Quantum Information Framework : NVIDIA A100 exascale.mahidol.ac.th Before Covid-19 there is shown of obstacles for Quantum Supremacy[7]. December 20...</p></div></div></a></div><div class="card"> <a href="/posts/Analog-IC-Layout/"><div class="card-body"> <em class="small" data-ts="1665334800" data-df="ll" > Oct 10, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Analog Ic Layout</h3><div class="text-muted small"><p> Python: Analog Inverter Chip Layout with Magic and PySpice Simulation on Sky 130nm PDK This notebook demo how to create inverter loayout and extract analog net-list to simulate with Sky 130 nm PDK...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Analog-IC-Layout/" class="btn btn-outline-primary" prompt="Older"><p>Analog Ic Layout</p></a> <a href="/posts/Quantum-Drug-Discovery/" class="btn btn-outline-primary" prompt="Newer"><p>Quantum Drug Discovery</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">SNIT SANGHLAO</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
