<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Monai_mednist_tutorial" /><meta property="og:locale" content="en" /><meta name="description" content="Setup environment Verify Monai running on exascale.mahidol.ac.th" /><meta property="og:description" content="Setup environment Verify Monai running on exascale.mahidol.ac.th" /><link rel="canonical" href="https://snitgit.github.io/posts/Monai_mednist_tutorial/" /><meta property="og:url" content="https://snitgit.github.io/posts/Monai_mednist_tutorial/" /><meta property="og:site_name" content="Extreme Tools for Science and Engineering Discovery" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-23T00:00:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Monai_mednist_tutorial" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-23T00:00:00+07:00","datePublished":"2022-09-23T00:00:00+07:00","description":"Setup environment Verify Monai running on exascale.mahidol.ac.th","headline":"Monai_mednist_tutorial","mainEntityOfPage":{"@type":"WebPage","@id":"https://snitgit.github.io/posts/Monai_mednist_tutorial/"},"url":"https://snitgit.github.io/posts/Monai_mednist_tutorial/"}</script><title>Monai_mednist_tutorial | Extreme Tools for Science and Engineering Discovery</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Extreme Tools for Science and Engineering Discovery"><meta name="application-name" content="Extreme Tools for Science and Engineering Discovery"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> </a></div><div class="site-title mt-3"> <a href="/">Extreme Tools for Science and Engineering Discovery</a></div><div class="site-subtitle font-italic">Welcome Faculty Visit</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/snitgit" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['snit.san','mahidol...'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Monai_mednist_tutorial</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Monai_mednist_tutorial</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1663866000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 23, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/username">SNIT SANGHLAO</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4910 words"> <em>27 min</em> read</span></div></div></div><div class="post-content"><h2 id="setup-environment-verify-monai-running-on-exascalemahidolacth"><span class="mr-2">Setup environment Verify Monai running on exascale.mahidol.ac.th</span><a href="#setup-environment-verify-monai-running-on-exascalemahidolacth" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h4 id="with-terminal-at-any-compute-node-run-docker-image-with-singularity"><span class="mr-2">With terminal at any Compute Node, run Docker image with Singularity</span><a href="#with-terminal-at-any-compute-node-run-docker-image-with-singularity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>$ singularity run –nv docker://projectmonai/monai</p><h4 id="run-notebook"><span class="mr-2">Run notebook</span><a href="#run-notebook" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>$ singularity shell –nv docker://projectmonai/monai</p><p>Singularity&gt; jupyter lab</p><h1 id="medical-image-classification-tutorial-with-the-mednist-dataset">Medical Image Classification Tutorial with the MedNIST Dataset</h1><p>In this tutorial, we introduce an end-to-end training and evaluation example based on the MedNIST dataset.</p><p>We’ll go through the following steps:</p><ul><li>Create a dataset for training and testing<li>Use MONAI transforms to pre-process data<li>Use the DenseNet from MONAI for classification<li>Train the model with a PyTorch program<li>Evaluate on test dataset</ul><p><a href="https://colab.research.google.com/github/Project-MONAI/tutorials/blob/main/2d_classification/mednist_tutorial.ipynb"><img data-src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab" data-proofer-ignore></a></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">torch</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="err">!</span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s">"import monai"</span> <span class="o">||</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="s">"monai-weekly[pillow, tqdm]"</span>
<span class="err">!</span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s">"import matplotlib"</span> <span class="o">||</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">matplotlib</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="err">!</span><span class="n">nvidia</span><span class="o">-</span><span class="n">smi</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre>Fri Sep 23 17:26:58 2022       
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 470.103.01   Driver Version: 470.103.01   CUDA Version: 11.7     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  NVIDIA A100-SXM...  On   | 00000000:07:00.0 Off |                    0 |
| N/A   34C    P0    68W / 400W |   3802MiB / 81251MiB |      5%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   1  NVIDIA A100-SXM...  On   | 00000000:0F:00.0 Off |                    0 |
| N/A   28C    P0    59W / 400W |      3MiB / 81251MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   2  NVIDIA A100-SXM...  On   | 00000000:47:00.0 Off |                    0 |
| N/A   29C    P0    58W / 400W |      3MiB / 81251MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   3  NVIDIA A100-SXM...  On   | 00000000:4E:00.0 Off |                    0 |
| N/A   30C    P0    58W / 400W |      3MiB / 81251MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   4  NVIDIA A100-SXM...  On   | 00000000:87:00.0 Off |                    0 |
| N/A   37C    P0    58W / 400W |      3MiB / 81251MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   5  NVIDIA A100-SXM...  On   | 00000000:90:00.0 Off |                    0 |
| N/A   33C    P0    64W / 400W |      3MiB / 81251MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   6  NVIDIA A100-SXM...  On   | 00000000:B7:00.0 Off |                    0 |
| N/A   33C    P0    61W / 400W |      3MiB / 81251MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
|   7  NVIDIA A100-SXM...  On   | 00000000:BD:00.0 Off |                    0 |
| N/A   33C    P0    59W / 400W |      3MiB / 81251MiB |      0%      Default |
|                               |                      |             Disabled |
+-------------------------------+----------------------+----------------------+
                                                                               
+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|    0   N/A  N/A   2429330      C   /opt/conda/bin/python3.8         3799MiB |
+-----------------------------------------------------------------------------+
</pre></table></code></div></div><h2 id="setup-imports"><span class="mr-2">Setup imports</span><a href="#setup-imports" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="c1"># Copyright 2020 MONAI Consortium
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">PIL</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span>

<span class="kn">from</span> <span class="nn">monai.apps</span> <span class="kn">import</span> <span class="n">download_and_extract</span>
<span class="kn">from</span> <span class="nn">monai.config</span> <span class="kn">import</span> <span class="n">print_config</span>
<span class="kn">from</span> <span class="nn">monai.data</span> <span class="kn">import</span> <span class="n">decollate_batch</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">monai.metrics</span> <span class="kn">import</span> <span class="n">ROCAUCMetric</span>
<span class="kn">from</span> <span class="nn">monai.networks.nets</span> <span class="kn">import</span> <span class="n">DenseNet121</span>
<span class="kn">from</span> <span class="nn">monai.transforms</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Activations</span><span class="p">,</span>
    <span class="n">EnsureChannelFirst</span><span class="p">,</span>
    <span class="n">AsDiscrete</span><span class="p">,</span>
    <span class="n">Compose</span><span class="p">,</span>
    <span class="n">LoadImage</span><span class="p">,</span>
    <span class="n">RandFlip</span><span class="p">,</span>
    <span class="n">RandRotate</span><span class="p">,</span>
    <span class="n">RandZoom</span><span class="p">,</span>
    <span class="n">ScaleIntensity</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">monai.utils</span> <span class="kn">import</span> <span class="n">set_determinism</span>

<span class="n">print_config</span><span class="p">()</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre>MONAI version: 1.0.0+5.g84e271ec
Numpy version: 1.22.4
Pytorch version: 1.13.0a0+d321be6
MONAI flags: HAS_EXT = True, USE_COMPILED = False, USE_META_DICT = False
MONAI rev id: 84e271ec939330e7cedf22b3871c4a2a62d3c2a2
MONAI __file__: /opt/monai/monai/__init__.py

Optional dependencies:
Pytorch Ignite version: 0.4.10
Nibabel version: 4.0.2
scikit-image version: 0.19.3
Pillow version: 9.0.1
Tensorboard version: 2.9.1
gdown version: 4.5.1
TorchVision version: 0.14.0a0
tqdm version: 4.62.3
lmdb version: 1.3.0
psutil version: 5.9.0
pandas version: 1.3.5
einops version: 0.4.1
transformers version: 4.21.3
mlflow version: 1.29.0
pynrrd version: 0.4.3

For details about installing the optional dependencies, please visit:
    https://docs.monai.io/en/latest/installation.html#installing-the-recommended-dependencies
</pre></table></code></div></div><h2 id="setup-data-directory"><span class="mr-2">Setup data directory</span><a href="#setup-data-directory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>You can specify a directory with the <code class="language-plaintext highlighter-rouge">MONAI_DATA_DIRECTORY</code> environment variable.<br /> This allows you to save results and reuse downloads.<br /> If not specified a temporary directory will be used.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"MONAI_DATA_DIRECTORY"</span><span class="p">)</span>
<span class="n">root_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="n">mkdtemp</span><span class="p">()</span> <span class="k">if</span> <span class="n">directory</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">directory</span>
<span class="k">print</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>/tmp/tmpbasuc2tx
</pre></table></code></div></div><h2 id="download-dataset"><span class="mr-2">Download dataset</span><a href="#download-dataset" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The MedNIST dataset was gathered from several sets from <a href="https://wiki.cancerimagingarchive.net/display/Public/Data+Usage+Policies+and+Restrictions">TCIA</a>, <a href="http://rsnachallenges.cloudapp.net/competitions/4">the RSNA Bone Age Challenge</a>, and <a href="https://cloud.google.com/healthcare/docs/resources/public-datasets/nih-chest">the NIH Chest X-ray dataset</a>.</p><p>The dataset is kindly made available by <a href="https://www.mayo.edu/research/labs/radiology-informatics/overview">Dr. Bradley J. Erickson M.D., Ph.D.</a> (Department of Radiology, Mayo Clinic) under the Creative Commons <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0 license</a>.</p><p>If you use the MedNIST dataset, please acknowledge the source.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">resource</span> <span class="o">=</span> <span class="s">"https://github.com/Project-MONAI/MONAI-extra-test-data/releases/download/0.8.1/MedNIST.tar.gz"</span>
<span class="n">md5</span> <span class="o">=</span> <span class="s">"0bc7306e7427e00ad1c5526a6677552d"</span>

<span class="n">compressed_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s">"MedNIST.tar.gz"</span><span class="p">)</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s">"MedNIST"</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
    <span class="n">download_and_extract</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">compressed_file</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">md5</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>MedNIST.tar.gz: 59.0MB [00:07, 8.56MB/s]                                                               

2022-09-23 17:24:15,104 - INFO - Downloaded: /tmp/tmpbasuc2tx/MedNIST.tar.gz
2022-09-23 17:24:15,204 - INFO - Verified 'MedNIST.tar.gz', md5: 0bc7306e7427e00ad1c5526a6677552d.
2022-09-23 17:24:15,205 - INFO - Writing into directory: /tmp/tmpbasuc2tx.
</pre></table></code></div></div><h2 id="set-deterministic-training-for-reproducibility"><span class="mr-2">Set deterministic training for reproducibility</span><a href="#set-deterministic-training-for-reproducibility" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">set_determinism</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></table></code></div></div><h2 id="read-image-filenames-from-the-dataset-folders"><span class="mr-2">Read image filenames from the dataset folders</span><a href="#read-image-filenames-from-the-dataset-folders" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>First of all, check the dataset files and show some statistics.<br /> There are 6 folders in the dataset: Hand, AbdomenCT, CXR, ChestCT, BreastMRI, HeadCT,<br /> which should be used as the labels to train our classification model.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="n">class_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
                     <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>
<span class="n">num_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_names</span><span class="p">)</span>
<span class="n">image_files</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span>
        <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_class</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">num_each</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_class</span><span class="p">)]</span>
<span class="n">image_files_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">image_class</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_class</span><span class="p">):</span>
    <span class="n">image_files_list</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">image_class</span><span class="p">.</span><span class="n">extend</span><span class="p">([</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_each</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">num_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_class</span><span class="p">)</span>
<span class="n">image_width</span><span class="p">,</span> <span class="n">image_height</span> <span class="o">=</span> <span class="n">PIL</span><span class="p">.</span><span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">image_files_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="n">size</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Total image count: </span><span class="si">{</span><span class="n">num_total</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Image dimensions: </span><span class="si">{</span><span class="n">image_width</span><span class="si">}</span><span class="s"> x </span><span class="si">{</span><span class="n">image_height</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Label names: </span><span class="si">{</span><span class="n">class_names</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Label counts: </span><span class="si">{</span><span class="n">num_each</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>Total image count: 58954
Image dimensions: 64 x 64
Label names: ['AbdomenCT', 'BreastMRI', 'CXR', 'ChestCT', 'Hand', 'HeadCT']
Label counts: [10000, 8954, 10000, 10000, 10000, 10000]
</pre></table></code></div></div><h2 id="randomly-pick-images-from-the-dataset-to-visualize-and-check"><span class="mr-2">Randomly pick images from the dataset to visualize and check</span><a href="#randomly-pick-images-from-the-dataset-to-visualize-and-check" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="n">num_total</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)):</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">PIL</span><span class="p">.</span><span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">image_files_list</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">class_names</span><span class="p">[</span><span class="n">image_class</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">"gray"</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></table></code></div></div><p><img data-src="/assets/notebooks/2022-09-23-Monai_mednist_tutorial_files/2022-09-23-Monai_mednist_tutorial_16_0.png" alt="Jupyter Notebook Plot" data-proofer-ignore></p><h2 id="prepare-training-validation-and-test-data-lists"><span class="mr-2">Prepare training, validation and test data lists</span><a href="#prepare-training-validation-and-test-data-lists" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Randomly select 10% of the dataset as validation and 10% as test.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="n">val_frac</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">test_frac</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_files_list</span><span class="p">)</span>
<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
<span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

<span class="n">test_split</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_frac</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span>
<span class="n">val_split</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val_frac</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="n">test_split</span>
<span class="n">test_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:</span><span class="n">test_split</span><span class="p">]</span>
<span class="n">val_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">test_split</span><span class="p">:</span><span class="n">val_split</span><span class="p">]</span>
<span class="n">train_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">val_split</span><span class="p">:]</span>

<span class="n">train_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_files_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">train_indices</span><span class="p">]</span>
<span class="n">train_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_class</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">train_indices</span><span class="p">]</span>
<span class="n">val_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_files_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">val_indices</span><span class="p">]</span>
<span class="n">val_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_class</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">val_indices</span><span class="p">]</span>
<span class="n">test_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_files_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">test_indices</span><span class="p">]</span>
<span class="n">test_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_class</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">test_indices</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s">"Training count: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span><span class="si">}</span><span class="s">, Validation count: "</span>
    <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_x</span><span class="p">)</span><span class="si">}</span><span class="s">, Test count: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_x</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Training count: 47164, Validation count: 5895, Test count: 5895
</pre></table></code></div></div><h2 id="define-monai-transforms-dataset-and-dataloader-to-pre-process-data"><span class="mr-2">Define MONAI transforms, Dataset and Dataloader to pre-process data</span><a href="#define-monai-transforms-dataset-and-dataloader-to-pre-process-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="n">train_transforms</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">LoadImage</span><span class="p">(</span><span class="n">image_only</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">EnsureChannelFirst</span><span class="p">(),</span>
        <span class="n">ScaleIntensity</span><span class="p">(),</span>
        <span class="n">RandRotate</span><span class="p">(</span><span class="n">range_x</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">keep_size</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">RandFlip</span><span class="p">(</span><span class="n">spatial_axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
        <span class="n">RandZoom</span><span class="p">(</span><span class="n">min_zoom</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">max_zoom</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">val_transforms</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">(</span>
    <span class="p">[</span><span class="n">LoadImage</span><span class="p">(</span><span class="n">image_only</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">EnsureChannelFirst</span><span class="p">(),</span> <span class="n">ScaleIntensity</span><span class="p">()])</span>

<span class="n">y_pred_trans</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([</span><span class="n">Activations</span><span class="p">(</span><span class="n">softmax</span><span class="o">=</span><span class="bp">True</span><span class="p">)])</span>
<span class="n">y_trans</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([</span><span class="n">AsDiscrete</span><span class="p">(</span><span class="n">to_onehot</span><span class="o">=</span><span class="n">num_class</span><span class="p">)])</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MedNISTDataset</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_files</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">transforms</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">image_files</span> <span class="o">=</span> <span class="n">image_files</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">image_files</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">transforms</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">image_files</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span> <span class="bp">self</span><span class="p">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>


<span class="n">train_ds</span> <span class="o">=</span> <span class="n">MedNISTDataset</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">train_transforms</span><span class="p">)</span>
<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">train_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">val_ds</span> <span class="o">=</span> <span class="n">MedNISTDataset</span><span class="p">(</span><span class="n">val_x</span><span class="p">,</span> <span class="n">val_y</span><span class="p">,</span> <span class="n">val_transforms</span><span class="p">)</span>
<span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">val_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">test_ds</span> <span class="o">=</span> <span class="n">MedNISTDataset</span><span class="p">(</span><span class="n">test_x</span><span class="p">,</span> <span class="n">test_y</span><span class="p">,</span> <span class="n">val_transforms</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">test_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></table></code></div></div><h2 id="define-network-and-optimizer"><span class="mr-2">Define network and optimizer</span><a href="#define-network-and-optimizer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ol><li>Set learning rate for how much the model is updated per batch.<li>Set total epoch number, as we have shuffle and random transforms, so the training data of every epoch is different.<br /> And as this is just a get start tutorial, let’s just train 4 epochs.<br /> If train 10 epochs, the model can achieve 100% accuracy on test dataset.<li>Use DenseNet from MONAI and move to GPU devide, this DenseNet can support both 2D and 3D classification tasks.<li>Use Adam optimizer.</ol><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="s">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s">"cpu"</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">DenseNet121</span><span class="p">(</span><span class="n">spatial_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">out_channels</span><span class="o">=</span><span class="n">num_class</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">loss_function</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="mf">1e-5</span><span class="p">)</span>
<span class="n">max_epochs</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">val_interval</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">auc_metric</span> <span class="o">=</span> <span class="n">ROCAUCMetric</span><span class="p">()</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">print</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>cuda
</pre></table></code></div></div><h2 id="model-training"><span class="mr-2">Model training</span><a href="#model-training" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Execute a typical PyTorch training that run epoch loop and step loop, and do validation after every epoch.<br /> Will save the model weights to file if got best validation accuracy.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre><td class="rouge-code"><pre><span class="n">best_metric</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">best_metric_epoch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">epoch_loss_values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">metric_values</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_epochs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"-"</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"epoch </span><span class="si">{</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">max_epochs</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">batch_data</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">batch_data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">batch_data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">epoch_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_ds</span><span class="p">)</span> <span class="o">//</span> <span class="n">train_loader</span><span class="p">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s">, "</span>
            <span class="sa">f</span><span class="s">"train_loss: </span><span class="si">{</span><span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">epoch_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_ds</span><span class="p">)</span> <span class="o">//</span> <span class="n">train_loader</span><span class="p">.</span><span class="n">batch_size</span>
    <span class="n">epoch_loss</span> <span class="o">/=</span> <span class="n">step</span>
    <span class="n">epoch_loss_values</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"epoch </span><span class="si">{</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s"> average loss: </span><span class="si">{</span><span class="n">epoch_loss</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">val_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">model</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="nb">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">val_data</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
                <span class="n">val_images</span><span class="p">,</span> <span class="n">val_labels</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">val_data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                    <span class="n">val_data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cat</span><span class="p">([</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">model</span><span class="p">(</span><span class="n">val_images</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cat</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">val_labels</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">y_onehot</span> <span class="o">=</span> <span class="p">[</span><span class="n">y_trans</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">decollate_batch</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">detach</span><span class="o">=</span><span class="bp">False</span><span class="p">)]</span>
            <span class="n">y_pred_act</span> <span class="o">=</span> <span class="p">[</span><span class="n">y_pred_trans</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">decollate_batch</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)]</span>
            <span class="n">auc_metric</span><span class="p">(</span><span class="n">y_pred_act</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">auc_metric</span><span class="p">.</span><span class="n">aggregate</span><span class="p">()</span>
            <span class="n">auc_metric</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">y_pred_act</span><span class="p">,</span> <span class="n">y_onehot</span>
            <span class="n">metric_values</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">acc_value</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">eq</span><span class="p">(</span><span class="n">y_pred</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">acc_metric</span> <span class="o">=</span> <span class="n">acc_value</span><span class="p">.</span><span class="nb">sum</span><span class="p">().</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">acc_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="n">best_metric</span><span class="p">:</span>
                <span class="n">best_metric</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">best_metric_epoch</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">root_dir</span><span class="p">,</span> <span class="s">"best_metric_model.pth"</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"saved new best metric model"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s">"current epoch: </span><span class="si">{</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s"> current AUC: </span><span class="si">{</span><span class="n">result</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span>
                <span class="sa">f</span><span class="s">" current accuracy: </span><span class="si">{</span><span class="n">acc_metric</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span>
                <span class="sa">f</span><span class="s">" best AUC: </span><span class="si">{</span><span class="n">best_metric</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span>
                <span class="sa">f</span><span class="s">" at epoch: </span><span class="si">{</span><span class="n">best_metric_epoch</span><span class="si">}</span><span class="s">"</span>
            <span class="p">)</span>

<span class="k">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s">"train completed, best_metric: </span><span class="si">{</span><span class="n">best_metric</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> "</span>
    <span class="sa">f</span><span class="s">"at epoch: </span><span class="si">{</span><span class="n">best_metric_epoch</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
</pre><td class="rouge-code"><pre>----------
epoch 1/4
1/157, train_loss: 1.7905
2/157, train_loss: 1.7626
3/157, train_loss: 1.7371
4/157, train_loss: 1.7116
5/157, train_loss: 1.6850
6/157, train_loss: 1.6477
7/157, train_loss: 1.6469
8/157, train_loss: 1.5967
9/157, train_loss: 1.5772
10/157, train_loss: 1.5541
11/157, train_loss: 1.5259
12/157, train_loss: 1.5018
13/157, train_loss: 1.4797
14/157, train_loss: 1.4746
15/157, train_loss: 1.4627
16/157, train_loss: 1.4242
17/157, train_loss: 1.4104
18/157, train_loss: 1.3556
19/157, train_loss: 1.3459
20/157, train_loss: 1.3497
21/157, train_loss: 1.3167
22/157, train_loss: 1.3070
23/157, train_loss: 1.2892
24/157, train_loss: 1.2665
25/157, train_loss: 1.2887
26/157, train_loss: 1.2419
27/157, train_loss: 1.2158
28/157, train_loss: 1.2117
29/157, train_loss: 1.1599
30/157, train_loss: 1.1648
31/157, train_loss: 1.1376
32/157, train_loss: 1.1325
33/157, train_loss: 1.1057
34/157, train_loss: 1.0882
35/157, train_loss: 1.0878
36/157, train_loss: 1.0690
37/157, train_loss: 1.0404
38/157, train_loss: 1.0373
39/157, train_loss: 1.0288
40/157, train_loss: 1.0198
41/157, train_loss: 1.0534
42/157, train_loss: 0.9989
43/157, train_loss: 0.9581
44/157, train_loss: 0.9800
45/157, train_loss: 0.9438
46/157, train_loss: 0.9364
47/157, train_loss: 0.9325
48/157, train_loss: 0.8583
49/157, train_loss: 0.9325
50/157, train_loss: 0.8685
51/157, train_loss: 0.8607
52/157, train_loss: 0.8824
53/157, train_loss: 0.8850
54/157, train_loss: 0.8236
55/157, train_loss: 0.8076
56/157, train_loss: 0.8243
57/157, train_loss: 0.8005
58/157, train_loss: 0.8184
59/157, train_loss: 0.8012
60/157, train_loss: 0.7567
61/157, train_loss: 0.7632
62/157, train_loss: 0.7396
63/157, train_loss: 0.7593
64/157, train_loss: 0.7228
65/157, train_loss: 0.7203
66/157, train_loss: 0.7411
67/157, train_loss: 0.7002
68/157, train_loss: 0.7009
69/157, train_loss: 0.7318
70/157, train_loss: 0.6492
71/157, train_loss: 0.6831
72/157, train_loss: 0.6540
73/157, train_loss: 0.6611
74/157, train_loss: 0.6371
75/157, train_loss: 0.6515
76/157, train_loss: 0.6436
77/157, train_loss: 0.6124
78/157, train_loss: 0.5939
79/157, train_loss: 0.6436
80/157, train_loss: 0.6096
81/157, train_loss: 0.5772
82/157, train_loss: 0.6238
83/157, train_loss: 0.5836
84/157, train_loss: 0.5476
85/157, train_loss: 0.5270
86/157, train_loss: 0.5493
87/157, train_loss: 0.5139
88/157, train_loss: 0.5316
89/157, train_loss: 0.4883
90/157, train_loss: 0.5082
91/157, train_loss: 0.5078
92/157, train_loss: 0.5019
93/157, train_loss: 0.4842
94/157, train_loss: 0.4924
95/157, train_loss: 0.4652
96/157, train_loss: 0.4531
97/157, train_loss: 0.4363
98/157, train_loss: 0.4830
99/157, train_loss: 0.4879
100/157, train_loss: 0.4651
101/157, train_loss: 0.4365
102/157, train_loss: 0.4504
103/157, train_loss: 0.4245
104/157, train_loss: 0.4201
105/157, train_loss: 0.4420
106/157, train_loss: 0.4181
107/157, train_loss: 0.4398
108/157, train_loss: 0.4444
109/157, train_loss: 0.4060
110/157, train_loss: 0.4293
111/157, train_loss: 0.3760
112/157, train_loss: 0.3841
113/157, train_loss: 0.3836
114/157, train_loss: 0.3843
115/157, train_loss: 0.3926
116/157, train_loss: 0.3797
117/157, train_loss: 0.3463
118/157, train_loss: 0.3594
119/157, train_loss: 0.3682
120/157, train_loss: 0.3729
121/157, train_loss: 0.3252
122/157, train_loss: 0.3360
123/157, train_loss: 0.3300
124/157, train_loss: 0.3278
125/157, train_loss: 0.3313
126/157, train_loss: 0.3747
127/157, train_loss: 0.3247
128/157, train_loss: 0.3116
129/157, train_loss: 0.3438
130/157, train_loss: 0.2886
131/157, train_loss: 0.3485
132/157, train_loss: 0.3560
133/157, train_loss: 0.3011
134/157, train_loss: 0.3300
135/157, train_loss: 0.3039
136/157, train_loss: 0.2945
137/157, train_loss: 0.3143
138/157, train_loss: 0.2705
139/157, train_loss: 0.3192
140/157, train_loss: 0.3055
141/157, train_loss: 0.2892
142/157, train_loss: 0.2747
143/157, train_loss: 0.2495
144/157, train_loss: 0.2922
145/157, train_loss: 0.2819
146/157, train_loss: 0.2984
147/157, train_loss: 0.2438
148/157, train_loss: 0.2666
149/157, train_loss: 0.2859
150/157, train_loss: 0.2713
151/157, train_loss: 0.2337
152/157, train_loss: 0.2684
153/157, train_loss: 0.2396
154/157, train_loss: 0.2412
155/157, train_loss: 0.2665
156/157, train_loss: 0.2361
157/157, train_loss: 0.2319
158/157, train_loss: 0.2651
epoch 1 average loss: 0.7282
saved new best metric model
current epoch: 1 current AUC: 0.9979 current accuracy: 0.9628 best AUC: 0.9979 at epoch: 1
----------
epoch 2/4
1/157, train_loss: 0.2430
2/157, train_loss: 0.2423
3/157, train_loss: 0.2449
4/157, train_loss: 0.2248
5/157, train_loss: 0.2292
6/157, train_loss: 0.2180
7/157, train_loss: 0.2514
8/157, train_loss: 0.2432
9/157, train_loss: 0.2361
10/157, train_loss: 0.1946
11/157, train_loss: 0.1935
12/157, train_loss: 0.2468
13/157, train_loss: 0.2618
14/157, train_loss: 0.2052
15/157, train_loss: 0.2026
16/157, train_loss: 0.2044
17/157, train_loss: 0.2144
18/157, train_loss: 0.2303
19/157, train_loss: 0.2084
20/157, train_loss: 0.2019
21/157, train_loss: 0.1884
22/157, train_loss: 0.2108
23/157, train_loss: 0.2110
24/157, train_loss: 0.1985
25/157, train_loss: 0.2192
26/157, train_loss: 0.1841
27/157, train_loss: 0.2212
28/157, train_loss: 0.1863
29/157, train_loss: 0.1887
30/157, train_loss: 0.1960
31/157, train_loss: 0.1713
32/157, train_loss: 0.1688
33/157, train_loss: 0.1674
34/157, train_loss: 0.1880
35/157, train_loss: 0.1666
36/157, train_loss: 0.1842
37/157, train_loss: 0.1713
38/157, train_loss: 0.1974
39/157, train_loss: 0.1810
40/157, train_loss: 0.1947
41/157, train_loss: 0.1749
42/157, train_loss: 0.2326
43/157, train_loss: 0.2106
44/157, train_loss: 0.1624
45/157, train_loss: 0.1487
46/157, train_loss: 0.1724
47/157, train_loss: 0.1669
48/157, train_loss: 0.1736
49/157, train_loss: 0.1775
50/157, train_loss: 0.1723
51/157, train_loss: 0.1735
52/157, train_loss: 0.1559
53/157, train_loss: 0.1526
54/157, train_loss: 0.1601
55/157, train_loss: 0.1570
56/157, train_loss: 0.1619
57/157, train_loss: 0.1541
58/157, train_loss: 0.1830
59/157, train_loss: 0.1526
60/157, train_loss: 0.1895
61/157, train_loss: 0.1593
62/157, train_loss: 0.1595
63/157, train_loss: 0.1466
64/157, train_loss: 0.1269
65/157, train_loss: 0.1215
66/157, train_loss: 0.1434
67/157, train_loss: 0.1469
68/157, train_loss: 0.1449
69/157, train_loss: 0.1234
70/157, train_loss: 0.1674
71/157, train_loss: 0.1498
72/157, train_loss: 0.1493
73/157, train_loss: 0.1147
74/157, train_loss: 0.1362
75/157, train_loss: 0.1311
76/157, train_loss: 0.1126
77/157, train_loss: 0.1231
78/157, train_loss: 0.1362
79/157, train_loss: 0.1214
80/157, train_loss: 0.1322
81/157, train_loss: 0.1094
82/157, train_loss: 0.1324
83/157, train_loss: 0.1329
84/157, train_loss: 0.1064
85/157, train_loss: 0.1402
86/157, train_loss: 0.1354
87/157, train_loss: 0.1250
88/157, train_loss: 0.1310
89/157, train_loss: 0.1087
90/157, train_loss: 0.1167
91/157, train_loss: 0.1204
92/157, train_loss: 0.1244
93/157, train_loss: 0.1250
94/157, train_loss: 0.1424
95/157, train_loss: 0.1328
96/157, train_loss: 0.1088
97/157, train_loss: 0.1317
98/157, train_loss: 0.0987
99/157, train_loss: 0.1127
100/157, train_loss: 0.0909
101/157, train_loss: 0.1434
102/157, train_loss: 0.1138
103/157, train_loss: 0.1210
104/157, train_loss: 0.0901
105/157, train_loss: 0.0986
106/157, train_loss: 0.1226
107/157, train_loss: 0.1076
108/157, train_loss: 0.1164
109/157, train_loss: 0.1077
110/157, train_loss: 0.1028
111/157, train_loss: 0.0874
112/157, train_loss: 0.0962
113/157, train_loss: 0.1147
114/157, train_loss: 0.0992
115/157, train_loss: 0.0848
116/157, train_loss: 0.1218
117/157, train_loss: 0.0939
118/157, train_loss: 0.1227
119/157, train_loss: 0.1069
120/157, train_loss: 0.1095
121/157, train_loss: 0.1252
122/157, train_loss: 0.0996
123/157, train_loss: 0.0844
124/157, train_loss: 0.0979
125/157, train_loss: 0.1441
126/157, train_loss: 0.1036
127/157, train_loss: 0.1001
128/157, train_loss: 0.0950
129/157, train_loss: 0.1022
130/157, train_loss: 0.0776
131/157, train_loss: 0.0850
132/157, train_loss: 0.1019
133/157, train_loss: 0.1034
134/157, train_loss: 0.0910
135/157, train_loss: 0.0986
136/157, train_loss: 0.0765
137/157, train_loss: 0.0908
138/157, train_loss: 0.1176
139/157, train_loss: 0.1113
140/157, train_loss: 0.0779
141/157, train_loss: 0.0871
142/157, train_loss: 0.0958
143/157, train_loss: 0.0876
144/157, train_loss: 0.1181
145/157, train_loss: 0.1112
146/157, train_loss: 0.0980
147/157, train_loss: 0.0933
148/157, train_loss: 0.1106
149/157, train_loss: 0.0818
150/157, train_loss: 0.0976
151/157, train_loss: 0.1008
152/157, train_loss: 0.0950
153/157, train_loss: 0.0954
154/157, train_loss: 0.0822
155/157, train_loss: 0.0936
156/157, train_loss: 0.0946
157/157, train_loss: 0.0893
158/157, train_loss: 0.2379
epoch 2 average loss: 0.1450
saved new best metric model
current epoch: 2 current AUC: 0.9998 current accuracy: 0.9869 best AUC: 0.9998 at epoch: 2
----------
epoch 3/4
1/157, train_loss: 0.0969
2/157, train_loss: 0.0851
3/157, train_loss: 0.0765
4/157, train_loss: 0.0736
5/157, train_loss: 0.0909
6/157, train_loss: 0.0788
7/157, train_loss: 0.0887
8/157, train_loss: 0.0749
9/157, train_loss: 0.0842
10/157, train_loss: 0.0837
11/157, train_loss: 0.0768
12/157, train_loss: 0.0731
13/157, train_loss: 0.0827
14/157, train_loss: 0.0692
15/157, train_loss: 0.0691
16/157, train_loss: 0.0903
17/157, train_loss: 0.0774
18/157, train_loss: 0.0843
19/157, train_loss: 0.0715
20/157, train_loss: 0.0758
21/157, train_loss: 0.0868
22/157, train_loss: 0.0696
23/157, train_loss: 0.0775
24/157, train_loss: 0.1073
25/157, train_loss: 0.1210
26/157, train_loss: 0.0668
27/157, train_loss: 0.0599
28/157, train_loss: 0.0633
29/157, train_loss: 0.0760
30/157, train_loss: 0.0899
31/157, train_loss: 0.0845
32/157, train_loss: 0.0889
33/157, train_loss: 0.0737
34/157, train_loss: 0.0703
35/157, train_loss: 0.0758
36/157, train_loss: 0.0711
37/157, train_loss: 0.0781
38/157, train_loss: 0.0633
39/157, train_loss: 0.0774
40/157, train_loss: 0.0615
41/157, train_loss: 0.0657
42/157, train_loss: 0.0891
43/157, train_loss: 0.0927
44/157, train_loss: 0.0674
45/157, train_loss: 0.0734
46/157, train_loss: 0.0864
47/157, train_loss: 0.0567
48/157, train_loss: 0.0922
49/157, train_loss: 0.0613
50/157, train_loss: 0.0696
51/157, train_loss: 0.0959
52/157, train_loss: 0.0852
53/157, train_loss: 0.0843
54/157, train_loss: 0.0643
55/157, train_loss: 0.0666
56/157, train_loss: 0.0948
57/157, train_loss: 0.0620
58/157, train_loss: 0.0641
59/157, train_loss: 0.0878
60/157, train_loss: 0.0607
61/157, train_loss: 0.0649
62/157, train_loss: 0.0662
63/157, train_loss: 0.0575
64/157, train_loss: 0.0591
65/157, train_loss: 0.0697
66/157, train_loss: 0.0640
67/157, train_loss: 0.0678
68/157, train_loss: 0.0680
69/157, train_loss: 0.0685
70/157, train_loss: 0.0630
71/157, train_loss: 0.0750
72/157, train_loss: 0.0575
73/157, train_loss: 0.0703
74/157, train_loss: 0.0469
75/157, train_loss: 0.0486
76/157, train_loss: 0.0643
77/157, train_loss: 0.0665
78/157, train_loss: 0.0681
79/157, train_loss: 0.0411
80/157, train_loss: 0.0639
81/157, train_loss: 0.0644
82/157, train_loss: 0.0619
83/157, train_loss: 0.0713
84/157, train_loss: 0.0468
85/157, train_loss: 0.0822
86/157, train_loss: 0.0543
87/157, train_loss: 0.0633
88/157, train_loss: 0.0614
89/157, train_loss: 0.0561
90/157, train_loss: 0.0612
91/157, train_loss: 0.0459
92/157, train_loss: 0.0551
93/157, train_loss: 0.0573
94/157, train_loss: 0.0616
95/157, train_loss: 0.0581
96/157, train_loss: 0.0576
97/157, train_loss: 0.0708
98/157, train_loss: 0.0520
99/157, train_loss: 0.0504
100/157, train_loss: 0.0614
101/157, train_loss: 0.0548
102/157, train_loss: 0.0600
103/157, train_loss: 0.0431
104/157, train_loss: 0.0687
105/157, train_loss: 0.0390
106/157, train_loss: 0.0598
107/157, train_loss: 0.0742
108/157, train_loss: 0.0395
109/157, train_loss: 0.0509
110/157, train_loss: 0.0751
111/157, train_loss: 0.0609
112/157, train_loss: 0.0521
113/157, train_loss: 0.0465
114/157, train_loss: 0.0432
115/157, train_loss: 0.0612
116/157, train_loss: 0.0568
117/157, train_loss: 0.0710
118/157, train_loss: 0.0559
119/157, train_loss: 0.0505
120/157, train_loss: 0.0510
121/157, train_loss: 0.0498
122/157, train_loss: 0.0557
123/157, train_loss: 0.0386
124/157, train_loss: 0.0586
125/157, train_loss: 0.0423
126/157, train_loss: 0.0433
127/157, train_loss: 0.0770
128/157, train_loss: 0.0465
129/157, train_loss: 0.0621
130/157, train_loss: 0.0510
131/157, train_loss: 0.0534
132/157, train_loss: 0.0546
133/157, train_loss: 0.0647
134/157, train_loss: 0.0577
135/157, train_loss: 0.0550
136/157, train_loss: 0.0396
137/157, train_loss: 0.0409
138/157, train_loss: 0.0565
139/157, train_loss: 0.0600
140/157, train_loss: 0.0376
141/157, train_loss: 0.0658
142/157, train_loss: 0.0392
143/157, train_loss: 0.0607
144/157, train_loss: 0.0524
145/157, train_loss: 0.0482
146/157, train_loss: 0.0600
147/157, train_loss: 0.0695
148/157, train_loss: 0.0483
149/157, train_loss: 0.0417
150/157, train_loss: 0.0529
151/157, train_loss: 0.0595
152/157, train_loss: 0.0427
153/157, train_loss: 0.0392
154/157, train_loss: 0.0445
155/157, train_loss: 0.0412
156/157, train_loss: 0.0796
157/157, train_loss: 0.0418
158/157, train_loss: 0.0538
epoch 3 average loss: 0.0647
saved new best metric model
current epoch: 3 current AUC: 1.0000 current accuracy: 0.9917 best AUC: 1.0000 at epoch: 3
----------
epoch 4/4
1/157, train_loss: 0.0300
2/157, train_loss: 0.0368
3/157, train_loss: 0.0387
4/157, train_loss: 0.0494
5/157, train_loss: 0.0348
6/157, train_loss: 0.0519
7/157, train_loss: 0.0453
8/157, train_loss: 0.0338
9/157, train_loss: 0.0556
10/157, train_loss: 0.0546
11/157, train_loss: 0.0499
12/157, train_loss: 0.0272
13/157, train_loss: 0.0398
14/157, train_loss: 0.0441
15/157, train_loss: 0.0498
16/157, train_loss: 0.0422
17/157, train_loss: 0.0338
18/157, train_loss: 0.0750
19/157, train_loss: 0.0508
20/157, train_loss: 0.0583
21/157, train_loss: 0.0425
22/157, train_loss: 0.0456
23/157, train_loss: 0.0421
24/157, train_loss: 0.0571
25/157, train_loss: 0.0477
26/157, train_loss: 0.0625
27/157, train_loss: 0.0542
28/157, train_loss: 0.0519
29/157, train_loss: 0.0424
30/157, train_loss: 0.0378
31/157, train_loss: 0.0382
32/157, train_loss: 0.0441
33/157, train_loss: 0.0394
34/157, train_loss: 0.0724
35/157, train_loss: 0.0305
36/157, train_loss: 0.0452
37/157, train_loss: 0.0510
38/157, train_loss: 0.0426
39/157, train_loss: 0.0376
40/157, train_loss: 0.0536
41/157, train_loss: 0.0399
42/157, train_loss: 0.0354
43/157, train_loss: 0.0479
44/157, train_loss: 0.0349
45/157, train_loss: 0.0501
46/157, train_loss: 0.0355
47/157, train_loss: 0.0528
48/157, train_loss: 0.0457
49/157, train_loss: 0.0450
50/157, train_loss: 0.0391
51/157, train_loss: 0.0420
52/157, train_loss: 0.0327
53/157, train_loss: 0.0507
54/157, train_loss: 0.0391
55/157, train_loss: 0.0457
56/157, train_loss: 0.0274
57/157, train_loss: 0.0424
58/157, train_loss: 0.0302
59/157, train_loss: 0.0434
60/157, train_loss: 0.0531
61/157, train_loss: 0.0376
62/157, train_loss: 0.0384
63/157, train_loss: 0.0380
64/157, train_loss: 0.0411
65/157, train_loss: 0.0280
66/157, train_loss: 0.0379
67/157, train_loss: 0.0341
68/157, train_loss: 0.0385
69/157, train_loss: 0.0313
70/157, train_loss: 0.0540
71/157, train_loss: 0.0306
72/157, train_loss: 0.0378
73/157, train_loss: 0.0327
74/157, train_loss: 0.0270
75/157, train_loss: 0.0438
76/157, train_loss: 0.0409
77/157, train_loss: 0.0371
78/157, train_loss: 0.0296
79/157, train_loss: 0.0379
80/157, train_loss: 0.0262
81/157, train_loss: 0.0418
82/157, train_loss: 0.0528
83/157, train_loss: 0.0225
84/157, train_loss: 0.0564
85/157, train_loss: 0.0393
86/157, train_loss: 0.0298
87/157, train_loss: 0.0271
88/157, train_loss: 0.0435
89/157, train_loss: 0.0547
90/157, train_loss: 0.0360
91/157, train_loss: 0.0392
92/157, train_loss: 0.0293
93/157, train_loss: 0.0606
94/157, train_loss: 0.0350
95/157, train_loss: 0.0280
96/157, train_loss: 0.0347
97/157, train_loss: 0.0415
98/157, train_loss: 0.0356
99/157, train_loss: 0.0505
100/157, train_loss: 0.0360
101/157, train_loss: 0.0430
102/157, train_loss: 0.0335
103/157, train_loss: 0.0231
104/157, train_loss: 0.0413
105/157, train_loss: 0.0260
106/157, train_loss: 0.0375
107/157, train_loss: 0.0288
108/157, train_loss: 0.0321
109/157, train_loss: 0.0343
110/157, train_loss: 0.0406
111/157, train_loss: 0.0323
112/157, train_loss: 0.0406
113/157, train_loss: 0.0335
114/157, train_loss: 0.0262
115/157, train_loss: 0.0288
116/157, train_loss: 0.0216
117/157, train_loss: 0.0377
118/157, train_loss: 0.0299
119/157, train_loss: 0.0556
120/157, train_loss: 0.0283
121/157, train_loss: 0.0310
122/157, train_loss: 0.0326
123/157, train_loss: 0.0386
124/157, train_loss: 0.0220
125/157, train_loss: 0.0225
126/157, train_loss: 0.0431
127/157, train_loss: 0.0316
128/157, train_loss: 0.0368
129/157, train_loss: 0.0427
130/157, train_loss: 0.0390
131/157, train_loss: 0.0453
132/157, train_loss: 0.0276
133/157, train_loss: 0.0395
134/157, train_loss: 0.0232
135/157, train_loss: 0.0235
136/157, train_loss: 0.0320
137/157, train_loss: 0.0326
138/157, train_loss: 0.0252
139/157, train_loss: 0.0309
140/157, train_loss: 0.0199
141/157, train_loss: 0.0285
142/157, train_loss: 0.0236
143/157, train_loss: 0.0365
144/157, train_loss: 0.0353
145/157, train_loss: 0.0381
146/157, train_loss: 0.0333
147/157, train_loss: 0.0377
148/157, train_loss: 0.0247
149/157, train_loss: 0.0357
150/157, train_loss: 0.0327
151/157, train_loss: 0.0238
152/157, train_loss: 0.0183
153/157, train_loss: 0.0431
154/157, train_loss: 0.0352
155/157, train_loss: 0.0445
156/157, train_loss: 0.0222
157/157, train_loss: 0.0246
158/157, train_loss: 0.0596
epoch 4 average loss: 0.0386
saved new best metric model
current epoch: 4 current AUC: 1.0000 current accuracy: 0.9963 best AUC: 1.0000 at epoch: 4
train completed, best_metric: 1.0000 at epoch: 4
</pre></table></code></div></div><h2 id="plot-the-loss-and-metric"><span class="mr-2">Plot the loss and metric</span><a href="#plot-the-loss-and-metric" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="s">"train"</span><span class="p">,</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Epoch Average Loss"</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">epoch_loss_values</span><span class="p">))]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">epoch_loss_values</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">"epoch"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Val AUC"</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">val_interval</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_values</span><span class="p">))]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">metric_values</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">"epoch"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></table></code></div></div><p><img data-src="/assets/notebooks/2022-09-23-Monai_mednist_tutorial_files/2022-09-23-Monai_mednist_tutorial_28_0.png" alt="Jupyter Notebook Plot" data-proofer-ignore></p><h2 id="evaluate-the-model-on-test-dataset"><span class="mr-2">Evaluate the model on test dataset</span><a href="#evaluate-the-model-on-test-dataset" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>After training and validation, we already got the best model on validation test.<br /> We need to evaluate the model on test dataset to check whether it’s robust and not over-fitting.<br /> We’ll use these predictions to generate a classification report.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">model</span><span class="p">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">load</span><span class="p">(</span>
    <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s">"best_metric_model.pth"</span><span class="p">)))</span>
<span class="n">model</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>
<span class="n">y_true</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">test_data</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
        <span class="n">test_images</span><span class="p">,</span> <span class="n">test_labels</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">test_data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
            <span class="n">test_data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">test_images</span><span class="p">).</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)):</span>
            <span class="n">y_true</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_labels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">item</span><span class="p">())</span>
            <span class="n">y_pred</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">item</span><span class="p">())</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span>
    <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="n">class_names</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>              precision    recall  f1-score   support

   AbdomenCT     0.9919    0.9879    0.9899       995
   BreastMRI     0.9977    0.9920    0.9949       880
         CXR     1.0000    0.9949    0.9974       982
     ChestCT     0.9931    1.0000    0.9966      1014
        Hand     0.9952    0.9962    0.9957      1048
      HeadCT     0.9929    0.9990    0.9959       976

    accuracy                         0.9951      5895
   macro avg     0.9951    0.9950    0.9951      5895
weighted avg     0.9951    0.9951    0.9951      5895
</pre></table></code></div></div><h2 id="cleanup-data-directory"><span class="mr-2">Cleanup data directory</span><a href="#cleanup-data-directory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Remove directory if a temporary was used.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="n">directory</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">shutil</span><span class="p">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="gpu-utilization"><span class="mr-2">GPU Utilization</span><a href="#gpu-utilization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>| 0 N/A N/A 2429330 C /opt/conda/bin/python3.8 3799MiB | +—————————————————————————–+ Fri Sep 23 17:26:34 2022 +—————————————————————————–+ | NVIDIA-SMI 470.103.01 Driver Version: 470.103.01 CUDA Version: 11.4 | |——————————-+———————-+———————-+ | GPU Name Persistence-M| Bus-Id Disp.A | Volatile Uncorr. ECC | | Fan Temp Perf Pwr:Usage/Cap| Memory-Usage | GPU-Util Compute M. | | | | MIG M. | |===============================+======================+======================| | 0 NVIDIA A100-SXM… On | 00000000:07:00.0 Off | 0 | | N/A 39C P0 244W / 400W | 3802MiB / 81251MiB | 50% Default | | | | Disabled | +——————————-+———————-+———————-+</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Monai_mednist_tutorial+-+Extreme+Tools+for+Science+and+Engineering+Discovery&url=https%3A%2F%2Fsnitgit.github.io%2Fposts%2FMonai_mednist_tutorial%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Monai_mednist_tutorial+-+Extreme+Tools+for+Science+and+Engineering+Discovery&u=https%3A%2F%2Fsnitgit.github.io%2Fposts%2FMonai_mednist_tutorial%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fsnitgit.github.io%2Fposts%2FMonai_mednist_tutorial%2F&text=Monai_mednist_tutorial+-+Extreme+Tools+for+Science+and+Engineering+Discovery" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Tensor_network_in_Quantum_Information_Science_Engineering_Physics/">Tensor_network_in_quantum_information_science_engineering_physics</a><li><a href="/posts/Quantum-Drug-Discovery/">Quantum Drug Discovery</a><li><a href="/posts/CPU_RISC_V_Layout_multi_university_wafer/">Cpu_risc_v_layout_multi_university_wafer</a><li><a href="/posts/Reproducible-slurm-notebook/"> Reproducible Slurm Notebook</a><li><a href="/posts/Quantum-Exspesso/">Quantum ESPRESSO on exascale.mahidol.ac.th Multi-Node-Multi-GPUs MNMG Testing</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Tensor_network_in_Quantum_Information_Science_Engineering_Physics/"><div class="card-body"> <em class="small" data-ts="1669741200" data-df="ll" > Nov 30, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Tensor_network_in_quantum_information_science_engineering_physics</h3><div class="text-muted small"><p> Unify Quantum Information Science and Quantum Machine Learning with Quantum Tensor Networks as modern diagrammatic reasoning on GPUs Cluster Boring and waiting for NVIDIA cuQuantum appliance for m...</p></div></div></a></div><div class="card"> <a href="/posts/Quantum-Drug-Discovery/"><div class="card-body"> <em class="small" data-ts="1668618000" data-df="ll" > Nov 17, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Quantum Drug Discovery</h3><div class="text-muted small"><p> Drug Discovery: Protein Folding on IBM’s Qiskit Quantum Information Framework : NVIDIA A100 exascale.mahidol.ac.th Before Covid-19 there is shown of obstacles for Quantum Supremacy[7]. December 20...</p></div></div></a></div><div class="card"> <a href="/posts/CPU_RISC_V_Layout_multi_university_wafer/"><div class="card-body"> <em class="small" data-ts="1665680400" data-df="ll" > Oct 14, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Cpu_risc_v_layout_multi_university_wafer</h3><div class="text-muted small"><p> Chip RISC V CPU: Physical tape out in a Jupyter notebook on ExamScale Cluster Motivated by difficulty experiences in IC Design about 18 and 8 years ago, this note will save time and resource for ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Reproducible-slurm-notebook/" class="btn btn-outline-primary" prompt="Older"><p> Reproducible Slurm Notebook</p></a> <a href="/posts/Analog-IC-Layout/" class="btn btn-outline-primary" prompt="Newer"><p>Analog Ic Layout</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">SNIT SANGHLAO</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
